# === injected: __portal_init_db (always present) ===
import os, sqlite3
from datetime import datetime

def __portal_init_db():
    """Create base tables and seeds; safe to call multiple times."""
    def _db():
        try:
            return db()
        except Exception:
            BASE_DIR = os.path.dirname(os.path.abspath(__file__))
            con = sqlite3.connect(os.path.join(BASE_DIR, 'survey.db'), timeout=30, check_same_thread=False)
            con.row_factory = sqlite3.Row
            return con
    con = _db(); c = con.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, wallet_points INTEGER DEFAULT 0, created_at TEXT)')
    try:
        c.execute('CREATE TABLE IF NOT EXISTS games (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, thumbnail_url TEXT, play_url TEXT, embed_html TEXT, points_override INTEGER DEFAULT 0, min_seconds_override INTEGER DEFAULT 0, is_active INTEGER DEFAULT 1)')
    except Exception:
        c.execute('CREATE TABLE IF NOT EXISTS games (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, embed_url TEXT, is_active INTEGER DEFAULT 1)')
    c.execute('CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)')
    c.execute('CREATE TABLE IF NOT EXISTS ads (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, image_url TEXT, click_url TEXT, is_active INTEGER DEFAULT 1)')
    con.commit()
    if not c.execute("SELECT 1 FROM settings WHERE key='points_per_minute'").fetchone():
        c.execute("INSERT INTO settings(key,value) VALUES('points_per_minute','10')")
    if not c.execute("SELECT 1 FROM settings WHERE key='min_seconds_to_reward'").fetchone():
        c.execute("INSERT INTO settings(key,value) VALUES('min_seconds_to_reward','30')")
    if not c.execute('SELECT 1 FROM games').fetchone():
        try:
            c.execute('INSERT INTO games(title,thumbnail_url,play_url,embed_html,is_active) VALUES(?,?,?,?,1)', ('2048','', 'https://play2048.co/','',))
            c.execute('INSERT INTO games(title,thumbnail_url,play_url,embed_html,is_active) VALUES(?,?,?,?,1)', ('Tetris','', 'https://tetris.com/play-tetris','',))
        except Exception:
            c.execute('INSERT INTO games(title,embed_url,is_active) VALUES(?,?,1)', ('2048','https://play2048.co/'))
            c.execute('INSERT INTO games(title,embed_url,is_active) VALUES(?,?,1)', ('Tetris','https://tetris.com/play-tetris'))
    con.commit(); con.close()
# === /injected ===

# app.py â€” Survey Platform (Dynamic Profile Schema + Surveys + Wallet + CMS + Posts API + Pages API)
from flask import Flask, render_template, request, redirect, url_for, session, flash, abort, jsonify
from flask import render_template, request, redirect, url_for, flash, session, jsonify

from flask import render_template, request, redirect, url_for, flash

from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
from functools import wraps
import sqlite3, os, secrets, json, re
from datetime import datetime, timedelta

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DB_PATH  = os.path.join(BASE_DIR, "survey.db")

app = Flask(__name__)
app.config["SECRET_KEY"] = os.environ.get("SECRET_KEY") or "change-me-please"
app.config["MAX_CONTENT_LENGTH"] = 16 * 1024 * 1024  # 16MB uploads

from flask import url_for

def _safe_url(ep_name, default="/"):
    try:
        return url_for(ep_name)
    except Exception:
        return default

from flask import url_for

def _safe_url(ep_name, default="/"):
    """Ù‡Û†Ú©Ø§Ø±ÛŒ Ú¯Ø±Ù†Ú¯: Ù‡Û•ÙˆÚµ Ø¯Û•Ø¯Ø§Øª url_for Ø¨Ú©Ø§ØªØŒ Ø¦Û•Ú¯Û•Ø± Ø¦Û•Ùˆ endpointÛ• Ø¨ÙˆÙˆÙ†ÛŒ Ù†Û•Ø¨ÙˆÙˆØŒ
    Ø¨Û† default Ø¯Û•Ú¯Û•Ú•ÛØªÛ•ÙˆÛ• ØªØ§ Ù‡Û•ÚµÛ•ÛŒ BuildError Ù†Û•Ø¨ÛŒÙ†ÛŒØª."""
    try:
        return url_for(ep_name)
    except Exception:
        return default

def _page_form_html(page=None):
    slug  = page["slug"] if page else ""
    title = page["title"] if page else ""
    body  = page["body"] if page else ""

    back_url = _safe_url("admin_pages_list",
                _safe_url("api_pages_list",
                _safe_url("home", "/")))

    return f"""<!doctype html><meta charset="utf-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<div class="container py-4" style="max-width:980px">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{'Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ Ù¾Û•Ú•Û•' if page else 'Ù¾Û•Ú•Û•ÛŒ Ù†ÙˆÛ'}</h4>
    <div><a class="btn btn-sm btn-outline-secondary" href="{back_url}">Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>
  </div>
  <form method="post">
    <div class="mb-3">
      <label class="form-label">Slug</label>
      <input class="form-control" name="slug" value="{slug}" placeholder="about-us" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†</label>
      <input class="form-control" name="title" value="{title}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Ù†Ø§ÙˆÛ•Ú•Û†Ú©</label>
      <textarea id="page_body" name="body" rows="18">{body}</textarea>
      <div class="form-text">Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø®Ø´ØªÛ• Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•ÛŒØªØŒ ÙˆÛÙ†Û• Ú•Ø§Ú©ÛØ´Û•-Ø¯Ø§Ù†Û• Ù†Ø§ÙˆÛ•ÙˆÛ•â€¦</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button>
      {"<a class='btn btn-outline-info' target='_blank' href='" + url_for('page_public', slug=slug) + "'>Ø³Û•ÛŒØ±Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø±Ø¯Û•Ø³Øª</a>" if page else ""}
    </div>
</div>

<!-- TinyMCE self-hosted (no API key) -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js"></script>
<script>
  const TINY_BASE = "https://cdn.jsdelivr.net/npm/tinymce@6.8.3";
  tinymce.init({{
    selector: '#page_body',
    base_url: TINY_BASE,
    suffix: '.min',
    license_key: 'gpl',

    height: 600,
    directionality: 'rtl',
    menubar: 'file edit view insert format table tools help',
    plugins: 'preview searchreplace autolink directionality visualblocks visualchars fullscreen image link media codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help autoresize code table',
    toolbar: 'undo redo | blocks | bold italic underline forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | table tabledelete | link image media | hr codesample | removeformat | preview fullscreen',

    // ğŸ‘‡ Ù„Û• Ù¾Ø§ÛŒØªÛ†Ù† Ù‡Ø§ØªÙˆÙˆÛ• (Ù‡ÛŒ Ø¬ÛŒÙ†Ø¬Ø§ Ù†ÛŒÛŒÛ•)ØŒ Ùˆ Ú†ÙˆÙ†Ú©Û• f-stringÛ•ØŒ Ù‡Û•Ù…ÙˆÙˆ Ù‚ÙˆØ³Û•Ú©Ø§Ù† Ù„Û•Ø±Û•ÙˆÛ• Ø¯ÙˆÙˆØ¨ÚµÛ•Ú©Ø±Ø§ÙˆÙ†
    images_upload_url: '{url_for("admin_upload_image")}',

    file_picker_types: 'image',
    image_caption: true,
    image_advtab: true,
    paste_data_images: true,
    convert_urls: false,
    branding: false,
    statusbar: true,

    content_style: 'body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans Arabic,Arial;line-height:1.9}} img{{max-width:100%;height:auto}} table{{border-collapse:collapse}} td,th{{padding:8px}} h1,h2,h3{{margin-top:1.2em}}'
  }});
</script>
"""
# --- Auth decorators (must be defined before routes) ---
from functools import wraps
from flask import session, redirect, url_for, abort, flash

def login_required(f):
    @wraps(f)
    def inner(*args, **kwargs):
        if not session.get("user_id"):
            flash("ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.")
            # Ø¦Û•Ú¯Û•Ø± Ú•ÙˆÙˆØªÙ‰ login Ù‡Û•Ø¨ÙˆÙˆØŒ Ø¨Û† login Ø¨Ú•Û†ØŒ Ù†Û•Ú©Û•ÙˆÛ• Ù…Ø§ÚµÙ¾Û•Ú•
            return redirect(url_for("login") if "login" in app.view_functions else "/")
        return f(*args, **kwargs)
    return inner

def admin_required(f):
    @wraps(f)
    def inner(*args, **kwargs):
        if not session.get("user_id"):
            flash("ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.")
            return redirect(url_for("login") if "login" in app.view_functions else "/")
        if not session.get("is_admin"):
            abort(403)
        return f(*args, **kwargs)
    return inner

# --- Rich editor: image upload config ---
import os, sqlite3, time
from datetime import datetime
from flask import jsonify, request, url_for
from werkzeug.utils import secure_filename

BASE_DIR = os.path.dirname(__file__)
app.config["UPLOAD_FOLDER"] = os.path.join(BASE_DIR, "static", "uploads", "pages")
app.config["MAX_CONTENT_LENGTH"] = 10 * 1024 * 1024  # 10MB
ALLOWED_IMAGE_EXT = {"png", "jpg", "jpeg", "gif", "webp"}

# ensure upload dir exists
os.makedirs(app.config["UPLOAD_FOLDER"], exist_ok=True)

def _allowed_image(fname: str) -> bool:
    return "." in fname and fname.rsplit(".", 1)[-1].lower() in ALLOWED_IMAGE_EXT

# Ù‡Û•ÚµÚ¯Ø±ØªÙ†ÛŒ Ù‚ÙˆÙÚµÛŒ DB Ú©Û•Ù… Ø¨Ú©Û•: (Ø¦Û•Ú¯Û•Ø± Ù¾ÛØ´ÙˆÙˆØªØ± Ø¬ÛÚ¯ÛŒØ±Øª Ú©Ø±Ø¯ÙˆÙˆÛ•ØŒ Ù‡Û•Ù…Ø§Ù† db() Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•)
def db():
    con = sqlite3.connect(os.path.join(BASE_DIR, "survey.db"), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row
    con.execute("PRAGMA journal_mode=WAL;")
    con.execute("PRAGMA busy_timeout=30000;")
    con.execute("PRAGMA synchronous=NORMAL;")
    con.execute("PRAGMA foreign_keys=ON;")
    return con

# --- TinyMCE image upload endpoint ---
# ... Ú©Û†Ø¯ÛŒ Ù¾ÛØ´ÙˆÙˆ ...

# --- TinyMCE image upload endpoint ---
UPLOAD_PAGES_DIR = os.path.join(BASE_DIR, "static", "uploads", "pages")
os.makedirs(UPLOAD_PAGES_DIR, exist_ok=True)
ALLOWED_IMAGE_EXT = {"png","jpg","jpeg","gif","webp"}
@app.route("/admin/upload-image", methods=["POST"])
@admin_required
def admin_upload_image():
    f = request.files.get("file")
    if not f or not f.filename:
        return jsonify({"error": "no file"}), 400
    ext = f.filename.rsplit(".",1)[-1].lower()
    if ext not in ALLOWED_IMAGE_EXT:
        return jsonify({"error": "invalid type"}), 400
    base = secure_filename(f.filename.rsplit(".",1)[0])[:50] or "img"
    name = f"{base}_{datetime.utcnow().strftime('%Y%m%d%H%M%S')}.{ext}"
    f.save(os.path.join(UPLOAD_PAGES_DIR, name))
    return jsonify({"location": url_for("static", filename=f"uploads/pages/{name}")})

    # Ù†Ø§ÙˆÛ•Ú©Û• Ù¾Ø§Ú© Ø¨Ú©Û• Ùˆ timestamp Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•
    ext = f.filename.rsplit(".", 1)[-1].lower()
    base = secure_filename(f.filename.rsplit(".", 1)[0])[:50] or "img"
    ts = datetime.now().strftime("%Y%m%d%H%M%S")
    filename = f"{base}_{ts}.{ext}"
    save_path = os.path.join(app.config["UPLOAD_FOLDER"], filename)

    try:
        f.save(save_path)
    except Exception as e:
        return jsonify({"error": f"save failed: {e}"}), 500

    # URL Ù€ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± (served by /static)
    url = url_for("static", filename=f"uploads/pages/{filename}", _external=False)
    # TinyMCE expects {location: url}
    return jsonify({"location": url}), 200

# ---------------- Password policy (Server-side) ----------------
# â‰¥8 chars + at least 1 digit + 1 symbol, and must match confirm
PWD_REGEX = re.compile(r'^(?=.*\d)(?=.*[\W_]).{8,}$')

def validate_password(password: str, confirm: str):
    if password != confirm:
        return False, "Ù¾Ø§Ø³Û†Ø±Ø¯ Ùˆ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù¾Ø§Ø³Û†Ø±Ø¯ ÛŒÛ•Ú© Ù†Ø§Ú†Ù†."
    if len(password) < 8:
        return False, "Ù¾Ø§Ø³Û†Ø±Ø¯ Ù†Ø§Ø¨ÛØª Ú©Û•Ù…ØªØ± Ù„Û• Ù¨ Ù¾ÛŒØª Ø¨ÛØª."
    if not PWD_REGEX.search(password):
        return False, "Ù¾Ø§Ø³Û†Ø±Ø¯ Ù¾ÛÙˆÛŒØ³ØªÛ• Ù„Ø§Ù†ÛŒÚ©Û•Ù… Ù¡ Ú˜Ù…Ø§Ø±Û• Ùˆ Ù¡ Ù‡ÛÙ…Ø§ Ù„Û•Ø®Û† Ø¨Ú¯Ø±ÛØª."
    return True, ""

# ------------ Uploads ------------
UPLOAD_FOLDER = os.path.join(BASE_DIR, "static", "uploads")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
ALLOWED_EXTENSIONS = {"png","jpg","jpeg","gif","webp","svg","pdf","mp4","mov","avi","mp3","wav"}

def allowed_file(filename: str) -> bool:
    return "." in filename and filename.rsplit(".", 1)[1].lower() in ALLOWED_EXTENSIONS
# â¬‡ï¸ Ù„Û•Ø³Û•Ø±Û•ØªØ§ Ø¯ÚµÙ†ÛŒØ§Ø¨Û• Ø¦Û•Ù…Ø§Ù†Û• ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§ÙˆÙ†:
from flask import current_app, url_for

# â¬‡ï¸ Ø¦Û•Ù… context_processor Ù€Û• Ù‡Û•Ù…ÙˆÙˆ Ø´ÙˆÛÙ†Û• Ú¯Ø±Ù†Ú¯Û•Ú©Ø§Ù† Ø¨Û† Ù‚Ø§Ù„ÛŒØ¨Û•Ú©Ø§Ù† Ø¯Ø§Ø¨ÛŒÙ† Ø¯Û•Ú©Ø§Øª
@app.context_processor
def inject_template_globals():
    def has_endpoint(name: str) -> bool:
        try:
            return name in current_app.view_functions
        except Exception:
            return False

    def safe_url(endpoint: str, **kwargs) -> str:
        # Ø¨Û• Ø¬Ø§ÛŒ url_for Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ØŒ Ø³Û•Ø±Û•ØªØ§ Ø¯ÚµÙ†ÛŒØ§Ø¨Û• Ú•ÙˆÙˆØªÛ•Ú©Û• Ù‡Û•ÛŒÛ•
        if has_endpoint(endpoint):
            try:
                return url_for(endpoint, **kwargs)
            except Exception:
                return "#"
        return "#"

    # get_setting Ù„Û•ÙˆØ§Ù†Û•ÛŒÛ• Ù„Û• Ù¾Ú•Û†Ú˜Û•Ú©Û•Øª Ù‡Û•Ø¨ÛØªØ› Ø¦Û•Ú¯Û•Ø± Ù†Û•Ø¨ÛØªØŒ Ø¦Û•Ù… Ú¯Û•Ø±Û•Ú©ÛŒÛ•Ø´ Ø¨Û•Ø±Ø¯Û•Ø³Øª Ø¯Û•Ú©Ø§Øª
    def _get_setting(key, default=None):
        try:
            return get_setting(key, default)  # Ø¦Û•Ú¯Û•Ø± Ù¾ÛØ´ØªØ± Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§ÙˆÛ•
        except Exception:
            return default

    return {
        "current_app": current_app,  # ğŸ”§ Ø¯Ø§Ø¨ÛŒÙ†Ú©Ø±Ø¯Ù†ÛŒ current_app Ø¨Û† Ù‚Ø§Ù„ÛŒØ¨Û•Ú©Ø§Ù†
        "has_endpoint": has_endpoint,
        "safe_url": safe_url,
        "get_setting": _get_setting,
    }
# --- Image upload for TinyMCE (no docstring to avoid indent issues) ---
from flask import request, jsonify, url_for
from werkzeug.utils import secure_filename
from datetime import datetime
import os
from flask import url_for
def _safe_url(ep, default="/"):
    try: return url_for(ep)
    except Exception: return default
ALLOWED_IMAGE_EXT = {"png", "jpg", "jpeg", "gif", "webp"}
# Ø¯ÚµÙ†ÛŒØ§Ø¨Û• Ù„Û• Ø³Û•Ø±Û•ØªØ§ Ø¯Ø§Ù†Ø±Ø§ÙˆÛ•:
# app.config["UPLOAD_FOLDER"] = os.path.join(BASE_DIR, "static", "uploads", "pages")
# os.makedirs(app.config["UPLOAD_FOLDER"], exist_ok=True)

# ------------ DB helpers ------------
def db():
    con = sqlite3.connect(DB_PATH)
    con.row_factory = sqlite3.Row
    con.execute("PRAGMA foreign_keys=ON;")
    return con
def migrate():
    con = db(); c = con.cursor()
def db():
    con = sqlite3.connect(DB_PATH, timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row
    # PRAGMA Ù€Û•Ú©Ø§Ù†: ÛŒØ§Ø±Ù…Û•ØªÛŒ Ø¯Û•Ø¯Û•Ù† Ú©ÛØ´Û•ÛŒ Ù‚ÙˆÙÚµÛ•Ú©Û• Ú©Û•Ù… Ø¨ÛØª
    con.execute("PRAGMA journal_mode=WAL;")         # Readers/Writer Ø¨Û• Ø¦Ø§Ø³Ø§Ù†ÛŒâ€ŒØªØ±
    con.execute("PRAGMA busy_timeout=30000;")       # Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ ØªØ§ 30s Ú©Ø§ØªÛÚ© Ù‚ÙˆÙÚµÛ• Ù‡Û•ÛŒÛ•
    con.execute("PRAGMA synchronous=NORMAL;")       # Ø¨ÛÙ‡ÛØ²Ú©Ø±Ø¯Ù†ÛŒ I/O Ú©Û•Ù…ÛÚ©
    con.execute("PRAGMA foreign_keys=ON;")          # Ø¨Û† ØªÛ•Ù†Ø§Ø³ÙˆØ¨ÛŒ Ø¬Û†ÛŒÙ†Û•Ú©Ø§Ù†
    return con
    # users
    c.execute("""
    CREATE TABLE IF NOT EXISTS users(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE,
      email TEXT UNIQUE,
      password_hash TEXT NOT NULL,
      is_admin INTEGER NOT NULL DEFAULT 0,
      email_verified INTEGER NOT NULL DEFAULT 0,
      email_verify_token TEXT,
      reset_token TEXT,
      reset_token_exp DATETIME,
      api_token TEXT,
      api_token_exp DATETIME,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    """)

    # core profile
    c.execute("""
    CREATE TABLE IF NOT EXISTS profiles(
      user_id INTEGER PRIMARY KEY,
      full_name TEXT,
      middle_name TEXT,
      nickname TEXT,
      gender TEXT,
      phone_code TEXT,
      phone TEXT,
      age INTEGER,
      degree TEXT,
      city TEXT,
      family_status TEXT,
      work_type TEXT,
      political_member TEXT,
      own_house TEXT,
      own_car TEXT,
      wallet_points INTEGER NOT NULL DEFAULT 0,
      updated_at DATETIME,
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    """)

    # detailed per-section (snapshot + awarding)
    c.execute("""
    CREATE TABLE IF NOT EXISTS profile_details(
      user_id INTEGER NOT NULL,
      section TEXT NOT NULL,
      payload_json TEXT NOT NULL,
      awarded_points INTEGER NOT NULL DEFAULT 0,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY(user_id, section),
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    """)

    # app settings
    c.execute("""
    CREATE TABLE IF NOT EXISTS app_settings(
      key TEXT PRIMARY KEY,
      value TEXT
    );
    """)

    # CMS pages
    c.execute("""
    CREATE TABLE IF NOT EXISTS pages(
      slug TEXT PRIMARY KEY,
      title TEXT NOT NULL,
      html  TEXT NOT NULL,
      updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    """)

    # wallet
    c.execute("""
    CREATE TABLE IF NOT EXISTS wallet_transactions(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      type TEXT NOT NULL,   -- earn | spend | adjust | payout
      points INTEGER NOT NULL,
      note TEXT,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS payout_requests(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      method TEXT NOT NULL,     -- bank_card | mobile_topup
      provider TEXT,
      account TEXT NOT NULL,
      points INTEGER NOT NULL,
      money_cents INTEGER NOT NULL,
      status TEXT NOT NULL DEFAULT 'pending',
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      processed_at DATETIME,
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    """)

    c.execute("""
    CREATE TABLE IF NOT EXISTS ads(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      image_url TEXT,
      link_url TEXT,
      reward_points INTEGER DEFAULT 2,
      is_active INTEGER NOT NULL DEFAULT 1,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    """)
    
    # Add reward_points column if it doesn't exist (for existing databases)
    try:
        c.execute("ALTER TABLE ads ADD COLUMN reward_points INTEGER DEFAULT 2")
    except sqlite3.OperationalError:
        # Column already exists
        pass
   
    c.execute("""
    CREATE TABLE IF NOT EXISTS games(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      embed_url TEXT,
      is_active INTEGER NOT NULL DEFAULT 1,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    """)

    # surveys
    c.execute("""
    CREATE TABLE IF NOT EXISTS surveys(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      description TEXT,
      is_active INTEGER NOT NULL DEFAULT 1,
      reward_points INTEGER NOT NULL DEFAULT 10,
      allow_multiple INTEGER NOT NULL DEFAULT 0,
      created_by INTEGER,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(created_by) REFERENCES users(id) ON DELETE SET NULL
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS survey_questions(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      survey_id INTEGER NOT NULL,
      q_text TEXT NOT NULL,
      q_type TEXT NOT NULL,        -- text/textarea/number/date/select/radio/checkbox/yesno/rating5/scale10
      options_json TEXT,
      required INTEGER NOT NULL DEFAULT 0,
      position INTEGER NOT NULL DEFAULT 0,
      show_if_json TEXT,
      FOREIGN KEY(survey_id) REFERENCES surveys(id) ON DELETE CASCADE
    );
    """)
    # submissions & answers
    c.execute("""CREATE TABLE IF NOT EXISTS survey_submissions(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        survey_id INTEGER NOT NULL,
        user_id INTEGER,
        submitted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    )""")
    c.execute("""CREATE TABLE IF NOT EXISTS survey_answers(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        submission_id INTEGER NOT NULL,
        question_id INTEGER NOT NULL,
        answer_text TEXT
    )""")

    c.execute("""
    CREATE TABLE IF NOT EXISTS survey_responses(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      survey_id INTEGER NOT NULL,
      user_id INTEGER,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(survey_id) REFERENCES surveys(id) ON DELETE CASCADE,
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE SET NULL
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS survey_response_items(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      response_id INTEGER NOT NULL,
      question_id INTEGER NOT NULL,
      answer_text TEXT,
      FOREIGN KEY(response_id) REFERENCES survey_responses(id) ON DELETE CASCADE,
      FOREIGN KEY(question_id) REFERENCES survey_questions(id) ON DELETE CASCADE
    );
    """)

    # dynamic profile schema
    c.execute("""
    CREATE TABLE IF NOT EXISTS profile_packages(
      code TEXT PRIMARY KEY,             -- e.g., about/assets/work/social or any custom
      title TEXT NOT NULL,
      position INTEGER NOT NULL DEFAULT 0
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS profile_questions(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      pkg_code TEXT NOT NULL,
      q_text TEXT NOT NULL,
      q_type TEXT NOT NULL,             -- text/textarea/number/date/select/radio/checkbox/yesno/rating5/scale10
      options_json TEXT,
      required INTEGER NOT NULL DEFAULT 0,
      position INTEGER NOT NULL DEFAULT 0,
      expose_for_rules INTEGER NOT NULL DEFAULT 0,
      FOREIGN KEY(pkg_code) REFERENCES profile_packages(code) ON DELETE CASCADE
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS profile_answers(
      user_id INTEGER NOT NULL,
      pkg_code TEXT NOT NULL,
      question_id INTEGER NOT NULL,
      answer_text TEXT,
      PRIMARY KEY(user_id, question_id),
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
      FOREIGN KEY(pkg_code) REFERENCES profile_packages(code) ON DELETE CASCADE,
      FOREIGN KEY(question_id) REFERENCES profile_questions(id) ON DELETE CASCADE
    );
    """)

    # survey eligibility
    c.execute("""
    CREATE TABLE IF NOT EXISTS survey_eligibility(
      survey_id INTEGER PRIMARY KEY,
      rules_json TEXT NOT NULL,
      FOREIGN KEY(survey_id) REFERENCES surveys(id) ON DELETE CASCADE
    );
    """)

    # posts (for public/user posts with optional image)
    c.execute("""
    CREATE TABLE IF NOT EXISTS posts(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      title   TEXT NOT NULL,
      body    TEXT,
      image_url TEXT,
      is_published INTEGER NOT NULL DEFAULT 1,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME,
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    """)
    c.execute("CREATE INDEX IF NOT EXISTS idx_posts_pub ON posts(is_published, id DESC);")

    # NEW: logs for ad views & game plays (once per day per item)
    c.execute("""
    CREATE TABLE IF NOT EXISTS ad_views(
      user_id INTEGER NOT NULL,
      ad_id   INTEGER NOT NULL,
      day     TEXT    NOT NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY(user_id, ad_id, day),
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
      FOREIGN KEY(ad_id)   REFERENCES ads(id)   ON DELETE CASCADE
    );
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS game_plays(
      user_id INTEGER NOT NULL,
      game_id INTEGER NOT NULL,
      day     TEXT    NOT NULL,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY(user_id, game_id, day),
      FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
      FOREIGN KEY(game_id) REFERENCES games(id) ON DELETE CASCADE
    );
    """)

    # defaults
    def set_if_missing(k, v):
        row = c.execute("SELECT 1 FROM app_settings WHERE key=?", (k,)).fetchone()
        if not row:
            c.execute("INSERT INTO app_settings(key,value) VALUES (?,?)", (k, str(v)))

    set_if_missing("money_per_point", "10")        # IQD per point
    set_if_missing("min_payout_points", "100")
    set_if_missing("pts_profile_section", "20")

    # NEW default rewards for ads & games
    set_if_missing("pts_ad_view", "2")
    set_if_missing("pts_game_play", "5")

    # seed core packages (once)
    if not c.execute("SELECT 1 FROM profile_packages LIMIT 1").fetchone():
        c.executemany("INSERT INTO profile_packages(code,title,position) VALUES (?,?,?)", [
            ("about","Ø¯Û•Ø±Ø¨Ø§Ø±Û•ÛŒ Ù…Ù†", 10),
            ("assets","Ø³Û•Ø±Ù…Ø§ÛŒÛ•", 20),
            ("work","Ú©Ø§Ø±", 30),
            ("social","Ú©Û†Ù…Û•ÚµØ§ÛŒÛ•ØªÛŒ/Ø³ÛŒØ§Ø³ÛŒ", 40),
        ])

    con.commit(); con.close()
# PATCH: DB safety (Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ game_ads Ùˆ Ø³ØªÙˆÙ†Û•Ú©Ø§Ù†)
def _ensure_game_ads_schema():
    con = db(); c = con.cursor()
    # games: Ø³ØªÙˆÙ†Û• ØªØ§ÛŒØ¨Û•ØªÛŒÛ•Ú©Ø§Ù†
    c.execute("""CREATE TABLE IF NOT EXISTS games(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      play_url TEXT,
      embed_html TEXT,
      thumbnail_url TEXT,
      is_active INTEGER NOT NULL DEFAULT 1,
      points_override INTEGER,
      min_seconds_override INTEGER,
      created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    )""")
    try: c.execute("ALTER TABLE games ADD COLUMN points_override INTEGER")
    except Exception: pass
    try: c.execute("ALTER TABLE games ADD COLUMN min_seconds_override INTEGER")
    except Exception: pass

    # Ø®Ø´ØªÛ•ÛŒ Ù¾ÛÙˆÛ•Ø³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø±ÛŒÚ©Ù„Ø§Ù… Ø¨Û† ÛŒØ§Ø±ÛŒ
    c.execute("""CREATE TABLE IF NOT EXISTS game_ads(
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      game_id INTEGER NOT NULL,
      ad_id INTEGER NOT NULL,
      position TEXT NOT NULL DEFAULT 'pre'  -- pre | mid | post
    )""")
    con.commit(); con.close()

_ensure_game_ads_schema()

migrate()

# ------------ helpers / context ------------
def dev_send_email(purpose, to_email, link):
    print(f"[DEV-EMAIL] {purpose} -> {to_email}\n  {link}\n")

def get_setting(key, default=None):
    con = db(); c = con.cursor()
    row = c.execute("SELECT value FROM app_settings WHERE key=?", (key,)).fetchone()
    con.close()
    return (row["value"] if row else default)

def _safe_url(ep_name, default="/"):
    # Try url_for; if endpoint doesn't exist, return fallback URL
    try:
        return url_for(ep_name)
    except Exception:
        return default

def public_page_url(slug):
    # Accept dict/object/str and return a public page URL
    if isinstance(slug, dict):
        s = slug.get("slug") or slug.get("path") or slug.get("code")
    else:
        s = getattr(slug, "slug", None) if not isinstance(slug, str) else slug
    if not s:
        return "#"
    try:
        return url_for("page_public", slug=s)
    except Exception:
        return f"/p/{s}"

    # Ù‡Û•ÙˆÚµâ€ŒØ¯Ø§Ù† Ù„Û• Ú†Û•Ù†Ø¯ Ù†Ø§ÙˆÛŒ Ú•ÙˆÙˆØªÛŒ Ø²Û†Ø± Ø¨Û•Ú©Ø§Ø±Ø¨Ø±Ø¯Ø±Ø§Ùˆ
    for ep in ("page_public", "page_view", "cms_page"):
        try:
            return url_for(ep, slug=slug)
        except Exception:
            pass

    # Ù‡Û•ÙˆÚµ: Ø¦Û•Ú¯Û•Ø± Ù†Ø§ÙˆÛŒ endpoint Ù‡Û•Ù…Ø§Ù† Ù†Ø§ÙˆÛŒ slug Ø¨ÛØª (Ø¨Û† Ù¾Û•Ú•Û•ÛŒ ØªØ§ÛŒØ¨Û•Øª)
    try:
        return url_for(slug)
    except Exception:
        return "#"

def set_setting(key, value):
    con = db(); c = con.cursor()
    if c.execute("SELECT 1 FROM app_settings WHERE key=?", (key,)).fetchone():
        c.execute("UPDATE app_settings SET value=? WHERE key=?", (str(value), key))
    else:
        c.execute("INSERT INTO app_settings(key,value) VALUES (?,?)", (key, str(value)))
    con.commit(); con.close()
# Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Schema migration: Ø¦Û•Ú¯Û•Ø± Ø³ØªÙˆÙˆÙ† Ù†ÛŒÛŒÛ•ØŒ Ø®Û†Ú©Ø§Ø±Ø§Ù†Û• Ø²ÛŒØ§Ø¯ Ø¨Ú©Û• Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
import sqlite3

def migrate_schema():
    con = db(); c = con.cursor()

    # ÛŒØ§Ø±Ù…Û•ØªÛŒ: Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø³ØªÙˆÙˆÙ† Ø¨Û• Ø¦Ø§Ù…Ø§Ø¯Û•Ú©Ø±Ø¯Ù†
    def add_col(table, name, spec):
        info = c.execute(f"PRAGMA table_info({table})").fetchall()
        # sqlite3.Row ÛŒØ§Ù† tuple Ù€Û•Ú©Ø§Ù† Ù‡Û•Ø±Ø¯ÙˆÙˆ Ú•ÛÚ¯Ø±ÛŒ Ø¨Ú©Û•
        names = { (row["name"] if isinstance(row, sqlite3.Row) else row[1]) for row in info }
        if name not in names:
            c.execute(f"ALTER TABLE {table} ADD COLUMN {name} {spec}")

    # Ø¯ÚµÙ†ÛŒØ§Ø¨Û• Ø®Ø´ØªÛ•ÛŒ games Ù‡Û•ÛŒÛ• (Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ•ØŒ Ø¨Ù†Û•Ú•Û•Øª Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û• Ø¨Û• Ù„Ø§ÙˆØ§Ø²ØªØ±ÛŒÙ† Ø¯ÛŒÙÛŒÙ†ÛŒØ´Ù†)
    c.execute("CREATE TABLE IF NOT EXISTS games (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT NOT NULL)")

    # Ø³ØªÙˆÙˆÙ†Û• Ù¾ÛÙˆÛŒØ³ØªÛ•Ú©Ø§Ù† Ø¨Û† ÛŒØ§Ø±ÛŒ â€” Ù‡Û•Ø± ÛŒÛ•Ú© Ù†ÛŒØ¨ÙˆÙˆØŒ Ø²ÛŒØ§Ø¯ Ø¨Ú©Ø±ÛØª
    add_col("games", "play_url", "TEXT")
    add_col("games", "embed_html", "TEXT")
    add_col("games", "thumbnail_url", "TEXT")
    add_col("games", "is_active", "INTEGER DEFAULT 1")
    add_col("games", "points_override", "INTEGER")
    add_col("games", "min_seconds_override", "INTEGER")
    add_col("games", "created_at", "DATETIME DEFAULT CURRENT_TIMESTAMP")
    # removed invalid placeholder column

    con.commit(); con.close()

# Ø¨Ø§Ù†Ú¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù† Ù„Û• Ú©Ø§ØªÛŒ Ù‡Û•ÚµØ§ÙˆØ³Ø§Ù†Ø¯Ù†ÛŒ Ø¦Û•Ù¾
migrate_schema()

@app.context_processor
def inject_globals():
    return {
        "now": datetime.utcnow(),
        "money_per_point": int(get_setting("money_per_point","10")),
        "min_payout_points": int(get_setting("min_payout_points","100"))
    }
@app.context_processor
def _inject_links_helper():
    from flask import url_for, current_app

    def public_page_url(slug: str) -> str:
        """
        Ù‡Û•Ø±Ú©Ø§Øª Ù†Ø§ÙˆÛŒ slug Ù‡Ø§ÙˆØ´ÛÙˆÛ•ÛŒ Ù†Ø§ÙˆÛŒ endpoint Ø¨ÛØª (Ø¨Û† Ù†Ù…ÙˆÙˆÙ†Û• 'wallet'),
        Ù¾ÛØ´ØªØ± Ø¨Ú•Û† Ø¨Û† Ù‡Û•Ù…Ø§Ù† Ú•ÙˆÙˆØªÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†. ÙˆÛ•Ú¯Ø±Û• /p/<slug> Ú©Ø§ØªÛÚ©
        Ø¦Û•Ùˆ endpointÛ• Ø¨ÙˆÙˆÙ†ÛŒ Ù†ÛŒÛŒÛ•.
        """
        if not slug:
            return "#"
        # 1) Ù‡Û•ÙˆÚµ Ø¨Ø¯Ù‡ ÙˆÛ•Ú© Ù†Ø§ÙˆÛŒ endpoint Ù€ÛŒ ÙÚµØ§Ø³Ú© Ø¨Ù‡ÛÙ†ÛŒØª
        if slug in current_app.view_functions:
            try:
                return url_for(slug)
            except Exception:
                pass
        # 2) Ú©Û•Ø¨ÙˆÙˆÙ†ÛŒ Ú•ÙˆÙˆØªÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©ÛŒ Ù¾Û•Ú•Û•Ú©Ø§Ù†
        try:
            return url_for("page_by_slug", slug=slug)
        except Exception:
            return f"/p/{slug}"

    return {"public_page_url": public_page_url}


def login_required(f):
    @wraps(f)
    def _w(*a, **k):
        if not session.get("user_id"):
            flash("ØªÚ©Ø§ÛŒÛ• Ø³Û•Ø±Û•ØªØ§ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Ú©Û•.")
            return redirect(url_for("login"))
        return f(*a, **k)
    return _w

def admin_required(f):
    @wraps(f)
    def _w(*a, **k):
        if not session.get("is_admin"):
            flash("Ø¯Û•Ø³ØªÙ¾ÛÚ¯Û•ÛŒØ´ØªÙ†ÛŒ Ø¦Û•dmÛŒÙ† Ù†ÛŒÛŒÛ•.")
            return redirect(url_for("index"))
        return f(*a, **k)
    return _w

def slugify(s):
    s = (s or "").strip().lower()
    s = re.sub(r"[^a-z0-9\-]+", "-", s)
    s = re.sub(r"-{2,}", "-", s).strip("-")
    return s or "page"

def add_points(user_id, pts, note, typ="earn"):
    con = db(); c = con.cursor()
    c.execute("UPDATE profiles SET wallet_points = COALESCE(wallet_points,0) + ? WHERE user_id=?", (pts, user_id))
    c.execute("INSERT INTO wallet_transactions(user_id,type,points,note) VALUES (?,?,?,?)",
              (user_id, typ, pts, note))
    con.commit(); con.close()

# NEW: utility â€” check all profile packages completed

def completed_all_packages(user_id):
    con = db(); c = con.cursor()
    req = [r["code"] for r in c.execute("SELECT code FROM profile_packages").fetchall()]
    done = {r["section"] for r in c.execute("SELECT section FROM profile_details WHERE user_id=?", (user_id,)).fetchall()}
    con.close()
    missing = [code for code in req if code not in done]
    return len(missing) == 0, missing

# ---------------- API helpers ----------------
def api_json(ok=True, data=None, error=None, status=200):
    payload = {"ok": bool(ok)}
    if error:
        payload["error"] = str(error)
    if data is not None:
        payload["data"] = data
    return jsonify(payload), status

def row_to_post_dict(r):
    return {
        "id": r["id"],
        "user_id": r["user_id"],
        "title": r["title"],
        "body": r["body"],
        "image_url": r["image_url"],
        "is_published": bool(r["is_published"]),
        "created_at": r["created_at"],
        "updated_at": r["updated_at"],
    }

def save_uploaded_file(f):
    if not f or f.filename == "":
        return None
    if not allowed_file(f.filename):
        raise ValueError("ÙØ§ÛŒÙ„ÛŒ Ù†Ø§Ø¯Ø±Ø³Øª/Ù¾Ø´ØªÚ¯ÛŒØ±ÛŒ Ù†Ø§Ø¨Û† (extension).")
    name = secure_filename(f.filename)
    base, ext = os.path.splitext(name)
    unique = f"{slugify(base)}-{secrets.token_hex(4)}{ext.lower()}"
    f.save(os.path.join(UPLOAD_FOLDER, unique))
    return url_for("static", filename=f"uploads/{unique}", _external=True)

def _issue_api_token(user_id, hours=24*30):
    tok = secrets.token_urlsafe(32)
    exp = (datetime.utcnow() + timedelta(hours=hours)).strftime("%Y-%m-%d %H:%M:%S")
    con = db(); c = con.cursor()
    c.execute("UPDATE users SET api_token=?, api_token_exp=? WHERE id=?", (tok, exp, user_id))
    con.commit(); con.close()
    return tok, exp

def _find_user_by_token(token):
    if not token:
        return None
    con = db(); c = con.cursor()
    u = c.execute("SELECT * FROM users WHERE api_token=?", (token,)).fetchone()
    if not u:
        con.close(); return None
    try:
        exp = datetime.strptime(u["api_token_exp"], "%Y-%m-%d %H:%M:%S") if u["api_token_exp"] else None
    except Exception:
        exp = None
    if (exp is None) or (datetime.utcnow() > exp):
        con.close(); return None
    con.close()
    return u

def api_auth_required(f):
    @wraps(f)
    def _w(*a, **k):
        auth = request.headers.get("Authorization","")
        token = ""
        if auth.lower().startswith("bearer "):
            token = auth.split(None, 1)[1].strip()
        user = _find_user_by_token(token)
        if not user:
            return api_json(False, error="Unauthorized", status=401)
        request.api_user = user
        return f(*a, **k)
    return _w

def api_admin_required(f):
    @wraps(f)
    def _w(*a, **k):
        user = getattr(request, "api_user", None)
        if not user or not bool(user["is_admin"]):
            return api_json(False, error="Admin only", status=403)
        return f(*a, **k)
    return _w

# Minimal CORS (adjust for production)
@app.after_request
def add_cors(resp):
    resp.headers["Access-Control-Allow-Origin"] = "*"
    resp.headers["Access-Control-Allow-Headers"] = "Authorization, Content-Type"
    resp.headers["Access-Control-Allow-Methods"] = "GET, POST, PATCH, DELETE, OPTIONS"
    return resp
# â”€â”€â”€â”€â”€ Endpoint aliases (compat) â”€â”€â”€â”€â”€
# Ù‡Û•Ø±Ø¯ÙˆÙˆ Ù†Ø§ÙˆÛ•Ú©Ø§Ù† Ú©Ø§Ø± Ø¨Ú©Û•Ù†: admin_ads_edit Ùˆ admin_ad_edit
# Ø¦Û•Ú¯Û•Ø± ÛŒÛ•Ú©ÛÚ© ØªÛ†Ù…Ø§Ø± Ø¨ÙˆÙˆ Ùˆ Ø¦Û•ÙˆÛŒ ØªØ± Ù†Û•Ø¨ÙˆÙˆØŒ Ø¦Û•Ù„ÛŒØ§Ø³ Ø¯Û•Ù…Ø§Ù†ÛŒâ€ŒÙ†ÙˆÙˆØ³ÛØª.

# ------------ Auth ------------
@app.route("/register", methods=["GET","POST"])
def register():
    if request.method == "POST":
        # Fields mapped to register.html
        first_name  = (request.form.get("first_name","") or "").strip()
        father_name = (request.form.get("father_name","") or "").strip()
        nickname    = (request.form.get("nickname","") or "").strip()
        gender      = (request.form.get("gender","") or "").strip()
        phone_code  = (request.form.get("phone_code","") or "").strip() or "+964"
        phone_raw   = request.form.get("phone","") or ""
        phone       = re.sub(r"[^\d]", "", phone_raw)
        email       = (request.form.get("email","") or "").strip().lower()
        username_in = (request.form.get("username","") or "").strip()
        password    = request.form.get("password","") or ""
        confirm     = request.form.get("confirm_password","") or ""

        if not first_name or not father_name or not gender or not phone or not email or not password or not confirm:
            flash("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•ÙˆÛ•.", "error")
            return render_template("register.html")

        ok, msg = validate_password(password, confirm)
        if not ok:
            flash(msg, "error")
            return render_template("register.html")

        if username_in:
            username = slugify(username_in)[:30]
        else:
            base = email.split("@")[0] if "@" in email else first_name
            username = slugify(base)[:30] or f"user{secrets.randbelow(9999)}"

        con = db(); c = con.cursor()
        try:
            c.execute("INSERT INTO users(username,email,password_hash,is_admin,email_verified) VALUES (?,?,?,0,0)",
                      (username, email, generate_password_hash(password)))
            uid = c.lastrowid
            c.execute("""
              INSERT INTO profiles(user_id,full_name,middle_name,nickname,gender,phone_code,phone,wallet_points,updated_at)
              VALUES (?,?,?,?,?,?,?,0,CURRENT_TIMESTAMP)
            """, (uid, first_name, father_name, nickname, gender, phone_code, phone))
            token = secrets.token_urlsafe(32)
            c.execute("UPDATE users SET email_verify_token=? WHERE id= ?", (token, uid))
            con.commit()
        except sqlite3.IntegrityError:
            con.rollback(); con.close()
            flash("Ø¦Û•Ù… Ø¦ÛŒÙ…Û•ÛŒÙ„Û• ÛŒØ§Ù† Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± Ù¾ÛØ´ØªØ± Ù‡Û•ÛŒÛ•.", "error")
            return render_template("register.html")
        con.close()

        verify_link = url_for("verify_email", token=token, _external=True)
        dev_send_email("Verify Email", email, verify_link)
        return render_template("auth_verify_sent.html", email=email, link=verify_link)

    return render_template("register.html")

@app.route("/login", methods=["GET","POST"])
def login():
    if request.method == "POST":
        user_or_email = request.form.get("user_or_email","").strip().lower()
        password = request.form.get("password","")
        con = db(); c = con.cursor()
        u = c.execute("SELECT * FROM users WHERE username=? OR email=?", (user_or_email, user_or_email)).fetchone()
        con.close()
        if u and check_password_hash(u["password_hash"], password):
            if not (u["email_verified"] or 0):
                return render_template("auth_verify_notice.html", email=u["email"])
            session["user_id"] = u["id"]
            session["username"] = u["username"] or (u["email"] or "")
            session["is_admin"] = bool(u["is_admin"])
            flash("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª!")
            return redirect(url_for("index"))
        flash("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ù‡Û•ÚµÛ•ÛŒÛ•.", "error")
    return render_template("auth_login.html")

@app.route("/logout")
def logout():
    session.clear()
    flash("Ø¯Û•Ø±Ú†ÙˆÙˆÛŒØª.")
    return redirect(url_for("index"))

@app.route("/verify-email")
def verify_email():
    token = request.args.get("token","").strip()
    if not token: abort(400)
    con = db(); c = con.cursor()
    u = c.execute("SELECT id FROM users WHERE email_verify_token=?", (token,)).fetchone()
    if not u:
        con.close(); flash("Token Ù†Ø§Ø¯Ø±ÙˆØ³ØªÛ• ÛŒØ§Ù† Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÛ•."); return redirect(url_for("login"))
    c.execute("UPDATE users SET email_verified=1, email_verify_token=NULL WHERE id=?", (u["id"],))
    con.commit(); con.close()
    flash("Ø¦ÛŒÙ…Û•ÛŒÚµ Ø³Û•Ù„Ù…ÛÙ†Ø¯Ø±Ø§ÛŒÛ•. ØªÚ©Ø§ÛŒÛ• Ø¯ÙˆØ¨Ø§Ø±Û• Ø¨Ú†Û† Ù†Ø§Ùˆ Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û•Øª.")
    return redirect(url_for("login"))

@app.route("/verify/resend", methods=["GET","POST"])
def verify_resend():
    if request.method == "POST":
        email = (request.form.get("email","") or "").strip().lower()
        con = db(); c = con.cursor()
        u = c.execute("SELECT id,email_verified FROM users WHERE email=?", (email,)).fetchone()
        if not u:
            con.close(); flash("Ø¦Ù‡â€ŒÙˆ Ø¦ÛŒÙ…Û•ÛŒÚµÛ• Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("verify_resend"))
        if u["email_verified"]:
            con.close(); flash("Ø¦Ù‡â€ŒÙ… Ø¦ÛŒÙ…Û•ÛŒÚµÛ• Ù¾ÛØ´ØªØ± Ø³Û•Ù„Ù…ÛÙ†Ø¯Ø±Ø§ÛŒÛ•."); return redirect(url_for("login"))
        token = secrets.token_urlsafe(32)
        c.execute("UPDATE users SET email_verify_token=? WHERE id=?", (token, u["id"]))
        con.commit(); con.close()
        link = url_for("verify_email", token=token, _external=True)
        dev_send_email("Verify Email (Resend)", email, link)
        return render_template("auth_verify_sent.html", email=email, link=link)
    email = request.args.get("email","")
    return render_template("auth_verify_resend.html", email=email)

@app.route("/password/forgot", methods=["GET","POST"])
def password_forgot():
    if request.method == "POST":
        email = (request.form.get("email","") or "").strip().lower()
        con = db(); c = con.cursor()
        u = c.execute("SELECT id FROM users WHERE email=?", (email,)).fetchone()
        if u:
            token = secrets.token_urlsafe(32)
            exp = (datetime.utcnow() + timedelta(hours=2)).strftime("%Y-%m-%d %H:%M:%S")
            c.execute("UPDATE users SET reset_token=?, reset_token_exp=? WHERE id=?", (token, exp, u["id"]))
            con.commit()
            link = url_for("password_reset", token=token, _external=True)
            dev_send_email("Password Reset", email, link)
            con.close()
            return render_template("auth_reset_sent.html", email=email, link=link)
        con.close()
        return render_template("auth_reset_sent.html", email=email, link=None)
    return render_template("auth_forgot.html")

@app.route("/password/reset/<token>", methods=["GET","POST"])
def password_reset(token):
    con = db(); c = con.cursor()
    u = c.execute("SELECT id, reset_token_exp FROM users WHERE reset_token=?", (token,)).fetchone()
    if not u:
        con.close(); flash("Token Ù†Ø§Ø¯Ø±ÙˆØ³ØªÛ• ÛŒØ§Ù† Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÛ•."); return redirect(url_for("password_forgot"))
    try:
        exp = datetime.strptime(u["reset_token_exp"], "%Y-%m-%d %H:%M:%S")
    except Exception:
        exp = datetime.utcnow() - timedelta(seconds=1)
    if datetime.utcnow() > exp:
        c.execute("UPDATE users SET reset_token=NULL, reset_token_exp=NULL WHERE id=?", (u["id"],))
        con.commit(); con.close()
        flash("Token Ø¨Û•Ø³Û•Ø±Ú†ÙˆÙˆÛ•ØŒ Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù‡Û•ÙˆÚµØ¨Ø¯Û•.")
        return redirect(url_for("password_forgot"))
    if request.method == "POST":
        p1 = request.form.get("password","") or ""
        p2 = request.form.get("password2","") or ""
        ok, msg = validate_password(p1, p2)
        if not ok:
            flash(msg, "error")
            return redirect(url_for("password_reset", token=token))
        c.execute("UPDATE users SET password_hash=?, reset_token=NULL, reset_token_exp=NULL WHERE id=?",
                  (generate_password_hash(p1), u["id"]))
        con.commit(); con.close()
        flash("Ù¾Ø§Ø³Û†Ø±Ø¯ Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•. Ø¦ÛØ³ØªØ§ Ø¯Û•ØªÙˆØ§Ù†ÛŒ Ø¨Ú†ÛŒØªÛ• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.")
        return redirect(url_for("login"))
    con.close()
    return render_template("auth_reset.html")

# ------------ API v1: Auth (token) ------------
@app.route("/api/v1/auth/token", methods=["POST"]) 
def api_auth_token():
    # accept JSON or form
    if request.is_json:
        data = request.get_json(silent=True) or {}
        user_or_email = (data.get("user_or_email","") or "").strip().lower()
        password = data.get("password","") or ""
    else:
        user_or_email = (request.form.get("user_or_email","") or "").strip().lower()
        password = request.form.get("password","") or ""

    if not user_or_email or not password:
        return api_json(False, error="user_or_email Ùˆ password Ù¾ÛÙˆÛŒØ³ØªÙ†.", status=400)

    con = db(); c = con.cursor()
    u = c.execute("SELECT * FROM users WHERE username=? OR email=?", (user_or_email, user_or_email)).fetchone()
    con.close()
    if not u or not check_password_hash(u["password_hash"], password):
        return api_json(False, error="Ù†Ø§Ø³Ù†Ø§Ù…Û• ÛŒØ§Ù† Ù¾Ø§Ø³Û†Ø±Ø¯ Ù‡Û•ÚµÛ•.", status=401)
    if not (u["email_verified"] or 0):
        return api_json(False, error="Ø¦ÛŒÙ…Û•ÛŒÚµ Ø³Û•Ù„Ù…ÛÙ†Ø¯Ø±Ø§Ù†ÛŒ Ù†ÛŒÛŒÛ•.", status=403)

    tok, exp = _issue_api_token(u["id"])
    return api_json(True, data={"token": tok, "expires_at": exp})

# ------------ API v1: Upload (image/file) ------------
@app.route("/api/v1/uploads", methods=["POST"]) 
@api_auth_required
def api_upload():
    if "file" not in request.files:
        return api_json(False, error="file Ù¾ÛÙˆÛŒØ³ØªÛ•", status=400)
    try:
        url = save_uploaded_file(request.files["file"])
        return api_json(True, data={"url": url})
    except ValueError as e:
        return api_json(False, error=str(e), status=400)

# ------------ API v1: Pages (public + admin CRUD) ------------
# Public read
@app.route("/api/v1/pages/<slug>", methods=["GET"]) 
def api_pages_public_get(slug):
    con = db(); c = con.cursor()
    p = c.execute("SELECT slug,title,html,updated_at FROM pages WHERE slug=?", (slug,)).fetchone()
    con.close()
    if not p:
        return api_json(False, error="Not found", status=404)
    return api_json(True, data={"slug": p["slug"], "title": p["title"], "html": p["html"], "updated_at": p["updated_at"]})

# Admin list
@app.route("/api/v1/admin/pages", methods=["GET"]) 
@api_auth_required
@api_admin_required
def api_pages_list():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT slug,title,updated_at FROM pages ORDER BY updated_at DESC").fetchall()
    con.close()
    items = [{"slug": r["slug"], "title": r["title"], "updated_at": r["updated_at"]} for r in rows]
    return api_json(True, data={"items": items})

# Admin create
@app.route("/api/v1/admin/pages", methods=["POST"]) 
@api_auth_required
@api_admin_required
def api_pages_create():
    data = request.get_json(silent=True) or request.form
    title = (data.get("title") or "").strip()
    html  = (data.get("html") or "").strip()
    slug  = slugify((data.get("slug") or title))
    if not title or not html:
        return api_json(False, error="title Ùˆ html Ù¾ÛÙˆÛŒØ³ØªÙ†.", status=400)
    con = db(); c = con.cursor()
    try:
        c.execute("INSERT INTO pages(slug,title,html) VALUES (?,?,?)", (slug, title, html))
        con.commit()
    except sqlite3.IntegrityError:
        con.rollback(); con.close()
        return api_json(False, error="slug Ù¾ÛØ´ØªØ± Ù‡Û•ÛŒÛ•.", status=409)
    p = c.execute("SELECT slug,title,html,updated_at FROM pages WHERE slug=?", (slug,)).fetchone()
    con.close()
    return api_json(True, data={"slug": p["slug"], "title": p["title"], "html": p["html"], "updated_at": p["updated_at"]}, status=201)

# Admin update
@app.route("/api/v1/admin/pages/<slug>", methods=["PATCH"]) 
@api_auth_required
@api_admin_required
def api_pages_update(slug):
    data = request.get_json(silent=True) or request.form
    title = data.get("title")
    html  = data.get("html")
    con = db(); c = con.cursor()
    exists = c.execute("SELECT 1 FROM pages WHERE slug=?", (slug,)).fetchone()
    if not exists:
        con.close(); return api_json(False, error="Not found", status=404)
    cols, vals = [], []
    if title is not None:
        cols.append("title=?"); vals.append(title.strip())
    if html is not None:
        cols.append("html=?"); vals.append(html)
    if not cols:
        con.close(); return api_json(True, data={"updated": False})
    cols.append("updated_at=CURRENT_TIMESTAMP")
    q = f"UPDATE pages SET {', '.join(cols)} WHERE slug=?"
    vals.append(slug)
    c.execute(q, tuple(vals))
    con.commit()
    p = c.execute("SELECT slug,title,html,updated_at FROM pages WHERE slug=?", (slug,)).fetchone()
    con.close()
    return api_json(True, data={"slug": p["slug"], "title": p["title"], "html": p["html"], "updated_at": p["updated_at"]})

# Admin delete
@app.route("/api/v1/admin/pages/<slug>", methods=["DELETE"]) 
@api_auth_required
@api_admin_required
def api_pages_delete(slug):
    con = db(); c = con.cursor()
    row = c.execute("SELECT 1 FROM pages WHERE slug=?", (slug,)).fetchone()
    if not row:
        con.close(); return api_json(False, error="Not found", status=404)
    c.execute("DELETE FROM pages WHERE slug=?", (slug,))
    con.commit(); con.close()
    return api_json(True, data={"deleted": slug})

# Quick who-am-I
@app.route("/api/v1/me", methods=["GET"]) 
@api_auth_required
def api_me():
    u = request.api_user
    return api_json(True, data={"id": u["id"], "username": u["username"], "email": u["email"], "is_admin": bool(u["is_admin"])})

# ------------ API v1: Posts ------------
@app.route("/api/v1/posts", methods=["GET"]) 
def api_posts_public_list():
    page = max(int(request.args.get("page", 1) or 1), 1)
    per  = min(max(int(request.args.get("per_page", 20) or 20), 1), 100)
    off  = (page - 1) * per

    con = db(); c = con.cursor()
    rows = c.execute("""SELECT * FROM posts WHERE is_published=1
                        ORDER BY id DESC LIMIT ? OFFSET ?""", (per, off)).fetchall()
    total = c.execute("SELECT COUNT(*) FROM posts WHERE is_published=1").fetchone()[0]
    con.close()
    data = [row_to_post_dict(r) for r in rows]
    return api_json(True, data={"items": data, "page": page, "per_page": per, "total": total})

@app.route("/api/v1/posts/<int:pid>", methods=["GET"]) 
def api_posts_public_get(pid):
    con = db(); c = con.cursor()
    r = c.execute("SELECT * FROM posts WHERE id=?", (pid,)).fetchone()
    con.close()
    if not r or not r["is_published"]:
        return api_json(False, error="Not found", status=404)
    return api_json(True, data=row_to_post_dict(r))

@app.route("/api/v1/my/posts", methods=["GET"]) 
@api_auth_required
def api_my_posts():
    page = max(int(request.args.get("page", 1) or 1), 1)
    per  = min(max(int(request.args.get("per_page", 20) or 20), 1), 100)
    off  = (page - 1) * per

    uid = request.api_user["id"]
    con = db(); c = con.cursor()
    rows = c.execute("""SELECT * FROM posts WHERE user_id=? ORDER BY id DESC
                        LIMIT ? OFFSET ?""", (uid, per, off)).fetchall()
    total = c.execute("SELECT COUNT(*) FROM posts WHERE user_id=?", (uid,)).fetchone()[0]
    con.close()
    data = [row_to_post_dict(r) for r in rows]
    return api_json(True, data={"items": data, "page": page, "per_page": per, "total": total})

@app.route("/api/v1/posts", methods=["POST"]) 
@api_auth_required
def api_posts_create():
    uid = request.api_user["id"]

    # Read inputs from multipart or JSON
    if request.files or (request.form and not request.is_json):
        title = request.form.get("title")
        body  = request.form.get("body")
        is_pub= request.form.get("is_published")
        try:
            img_url = save_uploaded_file(request.files.get("image")) if "image" in request.files else None
        except ValueError as e:
            return api_json(False, error=str(e), status=400)
    else:
        js = request.get_json(silent=True) or {}
        title = js.get("title")
        body  = js.get("body")
        is_pub= js.get("is_published")
        img_url = js.get("image_url")

    if not title or not str(title).strip():
        return api_json(False, error="title Ù¾ÛÙˆÛŒØ³ØªÛ•.", status=400)

    is_published = 1 if str(is_pub).lower() in ("1","true","yes","on") else 0

    con = db(); c = con.cursor()
    c.execute("""INSERT INTO posts(user_id,title,body,image_url,is_published)
                 VALUES (?,?,?,?,?)""", (uid, title.strip(), (body or "").strip(), img_url, is_published))
    pid = c.lastrowid
    con.commit()
    r = c.execute("SELECT * FROM posts WHERE id=?", (pid,)).fetchone()
    con.close()
    return api_json(True, data=row_to_post_dict(r), status=201)

@app.route("/api/v1/my/posts/<int:pid>", methods=["PATCH"]) 
@api_auth_required
def api_posts_update(pid):
    uid = request.api_user["id"]
    con = db(); c = con.cursor()
    r = c.execute("SELECT * FROM posts WHERE id=?", (pid,)).fetchone()
    if not r:
        con.close(); return api_json(False, error="Not found", status=404)
    if (r["user_id"] != uid) and (not request.api_user["is_admin"]):
        con.close(); return api_json(False, error="Forbidden", status=403)

    # Read inputs from multipart or JSON
    if request.files or (request.form and not request.is_json):
        title = request.form.get("title")
        body  = request.form.get("body")
        is_pub = request.form.get("is_published")
        try:
            new_img = save_uploaded_file(request.files.get("image")) if "image" in request.files else None
        except ValueError as e:
            con.close(); return api_json(False, error=str(e), status=400)
    else:
        js = request.get_json(silent=True) or {}
        title = js.get("title")
        body  = js.get("body")
        is_pub= js.get("is_published")
        new_img = js.get("image_url")

    cols, vals = [], []
    if title is not None:
        cols.append("title=?"); vals.append(title.strip())
    if body is not None:
        cols.append("body=?"); vals.append(body.strip())
    if is_pub is not None:
        cols.append("is_published=?"); vals.append(1 if str(is_pub).lower() in ("1","true","yes","on") else 0)
    if new_img:
        cols.append("image_url=?"); vals.append(new_img)

    if cols:
        cols.append("updated_at=CURRENT_TIMESTAMP")
        q = f"UPDATE posts SET {', '.join(cols)} WHERE id=?"
        vals.append(pid)
        c.execute(q, tuple(vals))
        con.commit()

    r2 = c.execute("SELECT * FROM posts WHERE id=?", (pid,)).fetchone()
    con.close()
    return api_json(True, data=row_to_post_dict(r2))

@app.route("/api/v1/my/posts/<int:pid>", methods=["DELETE"]) 
@api_auth_required
def api_posts_delete(pid):
    uid = request.api_user["id"]
    con = db(); c = con.cursor()
    r = c.execute("SELECT user_id FROM posts WHERE id=?", (pid,)).fetchone()
    if not r:
        con.close(); return api_json(False, error="Not found", status=404)
    if (r["user_id"] != uid) and (not request.api_user["is_admin"]):
        con.close(); return api_json(False, error="Forbidden", status=403)
    c.execute("DELETE FROM posts WHERE id=?", (pid,))
    con.commit(); con.close()
    return api_json(True, data={"deleted": pid})

# ------------ Public pages ------------
@app.route("/")
def index():
    con = db(); c = con.cursor()
    active_surveys = c.execute("SELECT id,title,description,reward_points FROM surveys WHERE is_active=1 ORDER BY id DESC LIMIT 6").fetchall()
    active_ads     = c.execute("SELECT id,title,image_url,link_url FROM ads WHERE is_active=1 ORDER BY id DESC LIMIT 6").fetchall()
    con.close()
    return render_template("home.html", surveys=active_surveys, ads=active_ads)

@app.route("/surveys")
def surveys_page():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT id,title,description,is_active,reward_points,created_at FROM surveys ORDER BY id DESC").fetchall()
    con.close()
    return render_template("surveys.html", rows=rows)
from flask import Response
import io, csv

@app.route("/surveys/<int:survey_id>", methods=["GET","POST"])
@login_required
def survey_take(survey_id):
    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=? AND is_active=1", (survey_id,)).fetchone()
    if not s:
        con.close(); abort(404)

    qs = c.execute("SELECT * FROM survey_questions WHERE survey_id=? ORDER BY id", (survey_id,)).fetchall()

    if request.method == "POST":
        # ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø³Û•Ù„Ù…Ø§Ù†Ø¯Ù†
        c.execute("INSERT INTO survey_submissions(survey_id, user_id) VALUES (?,?)",
                  (survey_id, session.get("user_id")))
        sub_id = c.lastrowid

        # Ù‡Û•Ø± Ù¾Ø±Ø³ÛŒØ§Ø±ÛÚ©: q_<id>
        for q in qs:
            field = f"q_{q['id']}"
            if q["q_type"] == "multi":
                vals = request.form.getlist(field)  # Ú†Û•Ù†Ø¯ Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Û•
                ans = "|".join(v.strip() for v in vals if v.strip())
            else:
                ans = (request.form.get(field) or "").strip()
            c.execute("""INSERT INTO survey_answers(submission_id, question_id, answer_text)
                         VALUES (?,?,?)""", (sub_id, q["id"], ans))
        con.commit(); con.close()
        flash("Ø³ÙˆÙ¾Ø§Ø³! ÙˆÛ•ÚµØ§Ù…Û•Ú©Ø§Ù†Øª ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§Ù†.")
        return redirect(url_for("home"))

    con.close()
    # Ù‚Ø§Ù„ÛŒØ¨Û•Ú©Û• Ù‡Û•Ø¨ÙˆÙˆØŸ Ù‡Û•Ù…Ø§Ù†Û• Ø¨Û•Ú©Ø§Ø±Ø¨Ù‡ÛÙ†Û•â€”Ù†Û•Ø¨ÙˆÙˆ ÙÛ†ÚµØ¨Û•Ú© HTML
    try:
        return render_template("survey_take.html", s=s, qs=qs)
    except Exception:
        # ÙÛ†ÚµØ¨Û•Ú©: ÙÙˆØ±Ù…ÛŒ Ø³Ø§Ø¯Û•
        def input_for(q):
            name = f"q_{q['id']}"
            t = q["q_type"]
            opts = (q["q_options"] or "").split("|") if q["q_options"] else []
            if t == "single":
                return "<br>".join([f"<label><input type='radio' name='{name}' value='{o.strip()}'> {o.strip()}</label>" for o in opts])
            if t == "multi":
                return "<br>".join([f"<label><input type='checkbox' name='{name}' value='{o.strip()}'> {o.strip()}</label>" for o in opts])
            if t == "number":
                return f"<input type='number' name='{name}' step='1'>"
            return f"<input type='text' name='{name}'>"

        items = "".join([f"<div style='margin:12px 0'><b>{q['q_text']}</b><div>{input_for(q)}</div></div>" for q in qs]) or "<p>Ù‡ÛŒÚ† Ù¾Ø±Ø³ÛŒØ§Ø±ÛÚ© Ù†ÛŒÛŒÛ•.</p>"
        return f"""<!doctype html><meta charset='utf-8'>
        <h3 style="font-family:system-ui">{s['title']}</h3>
        <form method="post">{items}<button>Ù†Ø§Ø±Ø¯Ù†</button></form>"""
@app.route("/admin/surveys/<int:survey_id>/results")
@admin_required
def admin_survey_results(survey_id):
    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=?", (survey_id,)).fetchone()
    if not s: con.close(); abort(404)

    qs = c.execute("SELECT * FROM survey_questions WHERE survey_id=? ORDER BY id", (survey_id,)).fetchall()

    # Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†Û•Ú©Ø§Ù†/Ú˜Ù…Ø§Ø±Û•Ú©Ø±Ø¯Ù†
    results = []
    for q in qs:
        qid = q["id"]; qtype = q["q_type"]
        rows = c.execute("SELECT answer_text FROM survey_answers sa JOIN survey_submissions ss ON ss.id=sa.submission_id WHERE ss.survey_id=? AND sa.question_id=?", (survey_id, qid)).fetchall()
        values = [ (r["answer_text"] or "").strip() for r in rows ]

        summary = {"question": q, "type": qtype}

        if qtype in ("single", "multi"):
            # Ú©Û†Ù…Û•ÚµÛ•Ú©Ø±Ø¯Ù†ÛŒ Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†Û•Ú©Ø§Ù†
            from collections import Counter
            if qtype == "multi":
                flat = []
                for v in values:
                    if v:
                        flat.extend([x.strip() for x in v.split("|") if x.strip()])
                counts = Counter(flat)
            else:
                counts = Counter([v for v in values if v])
            summary["counts"] = counts
            summary["total"] = sum(counts.values())
        elif qtype == "number":
            nums = []
            for v in values:
                try:
                    nums.append(float(v))
                except Exception:
                    pass
            summary["stats"] = {
                "count": len(nums),
                "avg": (sum(nums)/len(nums)) if nums else None,
                "min": min(nums) if nums else None,
                "max": max(nums) if nums else None,
            }
        else:
            # text â€” ØªÛ•Ù†ÛŒØ§ Ù†Ù…ÙˆÙ†Û•ÛŒ Ù¥Ù  Ù‡ÛÙ†Ø§Ù†Û•
            summary["samples"] = values[:50]

        results.append(summary)

    total_subs = c.execute("SELECT COUNT(*) AS n FROM survey_submissions WHERE survey_id=?", (survey_id,)).fetchone()["n"]
    con.close()

    try:
        return render_template("admin_survey_results.html", s=s, results=results, total_subs=total_subs)
    except Exception:
        # ÙÛ†ÚµØ¨Û•Ú© HTML
        parts = [f"<h3 style='font-family:system-ui'>Ø¦Û•Ù†Ø¬Ø§Ù…Û•Ú©Ø§Ù† â€” {s['title']} (Ú©Û†ÛŒ ÙˆÛ•ÚµØ§Ù…: {total_subs})</h3>"]
        for item in results:
            q = item["question"]
            parts.append(f"<div style='margin:16px 0'><b>â€¢ {q['q_text']}</b> <small>({q['q_type']})</small><br>")
            if item["type"] in ("single","multi"):
                if item.get("counts"):
                    for opt, cnt in item["counts"].most_common():
                        parts.append(f"{opt or '(Ø®Ø§Ù„ÛŒ)'} â€” {cnt}<br>")
                else:
                    parts.append("Ù‡ÛŒÚ† ÙˆÛ•ÚµØ§Ù…ÛÚ© Ù†ÛŒÛŒÛ•.")
            elif item["type"] == "number":
                st = item["stats"]
                parts.append(f"Count={st['count']} | Avg={st['avg']} | Min={st['min']} | Max={st['max']}")
            else:
                smp = item.get("samples") or []
                if smp:
                    parts.append("<ul>" + "".join([f"<li>{v}</li>" for v in smp]) + "</ul>")
                else:
                    parts.append("Ù‡ÛŒÚ† ÙˆÛ•ÚµØ§Ù…ÛÚ© Ù†ÛŒÛŒÛ•.")
            parts.append("</div>")
        return "<!doctype html><meta charset='utf-8'>" + "".join(parts)
@app.route("/admin/surveys/<int:survey_id>/export.csv")
@admin_required
def admin_survey_export_csv(survey_id):
    con = db(); c = con.cursor()
    # Ø¨Û• Ø´ÛÙˆÛ•ÛŒ Â«row per answerÂ»
    rows = c.execute("""
        SELECT ss.id AS submission_id,
               ss.user_id,
               ss.submitted_at,
               q.id AS question_id,
               q.q_text,
               q.q_type,
               sa.answer_text
        FROM survey_submissions ss
        JOIN survey_answers sa ON sa.submission_id = ss.id
        JOIN survey_questions q ON q.id = sa.question_id
        WHERE ss.survey_id=?
        ORDER BY ss.id, q.id
    """, (survey_id,)).fetchall()
    con.close()

    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(["submission_id", "user_id", "submitted_at", "question_id", "q_text", "q_type", "answer_text"])
    for r in rows:
        writer.writerow([r["submission_id"], r["user_id"], r["submitted_at"], r["question_id"], r["q_text"], r["q_type"], r["answer_text"]])

    data = output.getvalue().encode("utf-8-sig")
    return Response(data, mimetype="text/csv",
                    headers={"Content-Disposition": f'attachment; filename="survey_{survey_id}_export.csv"'})

@app.route("/research")
def research_page():
    return render_template("research.html")

@app.route("/stats")
def stats_page():
    con = db(); c = con.cursor()
    counts = {
        "users":   c.execute("SELECT COUNT(*) FROM users").fetchone()[0],
        "surveys": c.execute("SELECT COUNT(*) FROM surveys").fetchone()[0],
        "answers": c.execute("SELECT COUNT(*) FROM survey_response_items").fetchone()[0],
        "ads":     c.execute("SELECT COUNT(*) FROM ads").fetchone()[0],
        "games":   c.execute("SELECT COUNT(*) FROM games").fetchone()[0],
    }
    con.close()
    return render_template("stats.html", counts=counts)

@app.route("/archive")
def archive_page():
    return render_template("archive.html")

@app.route("/ads")
def ads_page():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT * FROM ads WHERE is_active=1 ORDER BY id DESC").fetchall()
    con.close()
    return render_template("ads.html", rows=rows)

@app.route("/games")
def games_page():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT * FROM games WHERE is_active=1 ORDER BY id DESC").fetchall()
    con.close()
    return render_template("games.html", rows=rows)

@app.route("/about")
def about_page():
    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM pages WHERE slug='about'").fetchone()
    con.close()
    if p: return render_template("page_dynamic.html", page=p)
    return render_template("about.html")

@app.route("/contact")
def contact_page():
    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM pages WHERE slug='contact'").fetchone()
    con.close()
    if p: return render_template("page_dynamic.html", page=p)
    return render_template("contact.html")

@app.route("/p/<slug>")
def page_by_slug(slug):
    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM pages WHERE slug=?", (slug,)).fetchone()
    con.close()
    if not p: abort(404)
    return render_template("page_dynamic.html", page=p)
# PATCH: Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ Ø¨Ù†Û•Ú•Û•ØªÛŒ ÛŒØ§Ø±ÛŒ (Only if missing)
if 'admin_games_earn_settings' not in app.view_functions:
    @app.route("/admin/games-earn-settings", methods=["GET","POST"])
    @admin_required
    def admin_games_earn_settings():
        if request.method == "POST":
            try:
                set_setting("games_daily_quota", max(0, int(request.form.get("games_daily_quota") or "10")))
                set_setting("games_points_per_play", max(0, int(request.form.get("games_points_per_play") or "5")))
                set_setting("games_min_seconds", max(0, int(request.form.get("games_min_seconds") or "30")))
            except ValueError:
                flash("ØªÚ©Ø§ÛŒÛ• Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨Ù†ÙˆÙˆØ³Û•.")
                return redirect(url_for("admin_games_earn_settings"))
            flash("Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§.")
            return redirect(url_for("admin_games_earn_settings"))
        data = {
            "games_daily_quota": get_setting("games_daily_quota", "10"),
            "games_points_per_play": get_setting("games_points_per_play", "5"),
            "games_min_seconds": get_setting("games_min_seconds", "30"),
        }
        # Ù‚Ø§ÚµØ¨ Ù‡Û•Ø¨ÙˆÙˆ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•ØŒ Ù†Û•Ø¨ÙˆÙˆ fallback
        try:
            return render_template("admin_games_earn_settings.html", data=data)
        except Exception:
            return f"""<!doctype html><meta charset='utf-8'>
            <h2 style="font-family:system-ui">Game Earn Settings</h2>
            <form method="post">
              <div>Ú©Û†ØªØ§ÛŒÛŒ Ú•Û†Ú˜Ø§Ù†Û•: <input type="number" name="games_daily_quota" value="{data['games_daily_quota']}"></div>
              <div>Ù¾Û†ÛŒÙ†Øª/ÛŒØ§Ø±ÛŒ: <input type="number" name="games_points_per_play" value="{data['games_points_per_play']}"></div>
              <div>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•: <input type="number" name="games_min_seconds" value="{data['games_min_seconds']}"></div>
              <button>Save</button>
            </form>"""

# ---- Rewards: Ads (once per day) ----
@app.route("/ads/<int:ad_id>/go")
def ad_go(ad_id):
    con = db(); c = con.cursor()
    ad = c.execute("SELECT * FROM ads WHERE id=? AND is_active=1", (ad_id,)).fetchone()
    if not ad:
        con.close()
        flash("Ú•ÛÚ©Ù„Ø§Ù… Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• ÛŒØ§Ù† Ù†Ø§Ú†Ø§Ù„Ø§Ú©Û•.")
        return redirect(url_for("ads_page"))

    if session.get("user_id"):
        today = datetime.utcnow().strftime("%Y-%m-%d")
        row = c.execute("SELECT 1 FROM ad_views WHERE user_id=? AND ad_id=? AND day=?",
                        (session["user_id"], ad_id, today)).fetchone()
        if not row:
            c.execute("INSERT INTO ad_views(user_id,ad_id,day) VALUES (?,?,?)",
                      (session["user_id"], ad_id, today))
            con.commit()
            # Ù¾Û†ÛŒÙ†ØªÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ Ø¨Û•Ùˆ Ú•ÛÚ©Ù„Ø§Ù…Û• Ø¨Û•Ú©Ø§Ø± Ø¨Ù‡ÛÙ†Û•ØŒ Ø¦Û•Ú¯Û•Ø± Ù†Û•Ø¨ÙˆÙˆ Ù¾Û†ÛŒÙ†ØªÛŒ Ú¯Ø´ØªÛŒ Ø¨Û•Ú©Ø§Ø± Ø¨Ù‡ÛÙ†Û•
            pts = int(ad["reward_points"] or get_setting("pts_ad_view","2"))
            con.close()
            add_points(session["user_id"], pts, f"Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ú•ÛÚ©Ù„Ø§Ù… #{ad_id}", "earn")
            flash(f"Ø¨Û•Ù‡Ø±Û•Øª Ø¨Û•Ø¯Û•Ø³Øª Ù‡ÛÙ†Ø§: {pts} Ù¾Û†ÛŒÙ†Øª")
        else:
            con.close()
            flash("ØªÛ† Ø¦Û•Ù…Ú•Û† Ø¦Û•Ù… Ú•ÛÚ©Ù„Ø§Ù…Û•Øª Ø¨ÛŒÙ†ÛŒÙˆÛ•.")
    else:
        con.close()

    link = ad["link_url"] or url_for("ads_page")
    return redirect(link)
# ---- Rewards: Games (once per day) ----
@app.route("/games/<int:game_id>/play")
def game_play(game_id):
    con = db(); c = con.cursor()
    g = c.execute("SELECT * FROM games WHERE id=? AND is_active=1", (game_id,)).fetchone()
    if not g:
        con.close()
        flash("ÛŒØ§Ø±ÛŒ Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• ÛŒØ§Ù† Ù†Ø§Ú†Ø§Ù„Ø§Ú©Û•.")
        return redirect(url_for("games_page"))

    awarded = False
    if session.get("user_id"):
        today = datetime.utcnow().strftime("%Y-%m-%d")
        row = c.execute("SELECT 1 FROM game_plays WHERE user_id=? AND game_id=? AND day=?",
                        (session["user_id"], game_id, today)).fetchone()
        if not row:
            c.execute("INSERT INTO game_plays(user_id,game_id,day) VALUES (?,?,?)",
                      (session["user_id"], game_id, today))
            con.commit()
            pts = int(get_setting("pts_game_play","5"))
            con.close()
            add_points(session["user_id"], pts, f"ÛŒØ§Ø±ÛŒâ€ŒÚ©Ø±Ø¯Ù† #{game_id}", "earn")
            awarded = True
        else:
            con.close()

    return render_template("game_play.html", game=g, awarded=awarded)

# ------------ Profile core + packages (dynamic) ------------
@app.route("/profile", methods=["GET","POST"]) 
@login_required
def profile():
    # helper to read option lists (with defaults)
    def get_list_setting(key, default_list):
        try:
            raw = get_setting(key)
            if raw:
                arr = json.loads(raw)
                if isinstance(arr, list): return arr
        except Exception: pass
        return default_list

    defaults = {
      "degrees": ["Ø¨Û Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û•","Ø³Û•Ø±Û•ØªØ§ÛŒÛŒ","Ù†Ø§ÙˆÛ•Ù†Ø¯ÛŒ","Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛŒ","Ø¯Ø¨Ù„Û†Ù…","Ø¨ÙƒØ§Ù„Û†Ø±ÛŒÛ†Ø³","Ø¯Ø¨Ù„Û†Ù…ÛŒ Ø¨Ø§ÚµØ§","Ù…Ø§Ø³ØªÛ•Ø±","Ø¯ÙƒØªÛ†Ø±Ø§"],
      "cities": ["Ù‡Û•ÙˆÙ„ÛØ±","Ø³Ù„ÛÙ…Ø§Ù†ÛŒ","Ø¯Ù‡Û†Ú©","Ú©Û•Ø±Ú©ÙˆÚ©","Ù…ÙˆÙˆØ³Úµ","Ø¨Û•ØºØ¯Ø§Ø¯","Ø¨Û•ØµØ±Û•","Ù†Û•Ø¬Û•Ù","Ú©Û•Ø±Ø¨Û•Ù„Ø§"],
      "famstat": ["Ø®ÛØ²Ø§Ù†Ø¯Ø§Ø±","Ø³Û•ÚµØª","Ø¬ÛŒØ§Ø¨ÙˆÙˆÛ•ÙˆÛ•","Ù†Û•Ù…Ø§Ù†ÛŒ Ù‡Ø§ÙˆØ³Û•Ø±"],
      "work_types": ["Ø­Ú©ÙˆÙ…ÛŒ","Ø¦Û•Ù‡Ù„ÛŒ","Ø³Û•Ø±Ø¨Û•Ø®Û†","Ø±ÛÚ©Ø®Ø±Ø§ÙˆÛ•ÛŒÛŒ","Ø­Ø²Ø¨ÛŒ","Ù‡ÛŒØªØ±"],
    }

    if request.method == "POST":
        con = db(); c = con.cursor()
        full_name  = request.form.get("full_name"," ").strip()
        middle_name= request.form.get("middle_name"," ").strip()
        nickname   = request.form.get("nickname"," ").strip()
        gender     = request.form.get("gender"," ").strip()
        phone_code = request.form.get("phone_code"," ").strip()
        phone      = re.sub(r"[^\d]","", request.form.get("phone","") or "")
        age_val    = request.form.get("age"," ").strip()
        age        = int(age_val) if age_val.isdigit() else None
        degree     = request.form.get("degree"," ").strip()
        city       = request.form.get("city"," ").strip()
        family_status = request.form.get("family_status"," ").strip()
        work_type  = request.form.get("work_type"," ").strip()
        political_member = request.form.get("political_member"," ").strip()
        c.execute("""
          UPDATE profiles
          SET full_name=?, middle_name=?, nickname=?, gender=?, phone_code=?, phone=?, age=?, degree=?, city=?, family_status=?, work_type=?, political_member=?, updated_at=CURRENT_TIMESTAMP
          WHERE user_id=?
        """, (full_name, middle_name, nickname, gender, phone_code, phone, age, degree, city, family_status, work_type, political_member, session["user_id"]))
        con.commit(); con.close()
        flash("Ù¾Ú•Û†ÙØ§ÛŒÙ„ Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")

    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM profiles WHERE user_id=?", (session["user_id"],)).fetchone()
    pkgs = c.execute("SELECT code, title, position FROM profile_packages ORDER BY position, code").fetchall()
    comp = c.execute("SELECT section FROM profile_details WHERE user_id=?", (session["user_id"],)).fetchall()
    con.close()
    completed_codes = {row["section"] for row in comp}
    pkg_states = [{"code":x["code"],"title":x["title"],"position":x["position"],"done":(x["code"] in completed_codes)} for x in pkgs]

    # Build options for dropdowns
    opts = {
        "opt_degrees": get_list_setting("opt_degrees", defaults["degrees"]),
        "opt_cities": get_list_setting("opt_cities", defaults["cities"]),
        "opt_famstat": get_list_setting("opt_famstat", defaults["famstat"]),
        "opt_work_types": get_list_setting("opt_work_types", defaults["work_types"]),
        "opt_genders": ["Ù†ÛØ±","Ù…Û"],
        "opt_ages": [str(n) for n in range(15, 81)],
    }

    return render_template("profile.html", p=p, pkg_states=pkg_states, opts=opts)

# alias for old links if any
@app.route("/profile/setup") 
@login_required
def profile_setup():
    return redirect(url_for("profile"))

def _award_and_snapshot(user_id, code, payload_dict):
    pts = int(get_setting("pts_profile_section","20"))
    con = db(); c = con.cursor()
    row = c.execute("SELECT awarded_points FROM profile_details WHERE user_id=? AND section=?", (user_id, code)).fetchone()
    if row:
        c.execute("UPDATE profile_details SET payload_json=?, updated_at=CURRENT_TIMESTAMP WHERE user_id=? AND section=?",
                  (json.dumps(payload_dict, ensure_ascii=False), user_id, code))
        awarded = row["awarded_points"] or 0
    else:
        c.execute("INSERT INTO profile_details(user_id,section,payload_json,awarded_points) VALUES (?,?,?,?)",
                  (user_id, code, json.dumps(payload_dict, ensure_ascii=False), pts))
        awarded = 0
    con.commit(); con.close()
    if not row or awarded == 0:
        add_points(user_id, pts, f"Ù¾Ú•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù¾Ø§Ú©ÛØ¬ÛŒ Ù¾Ú•Û†ÙØ§ÛŒÙ„: {code}", "earn")

@app.route("/profile/sections/<code>", methods=["GET","POST"]) 
@login_required
def profile_sec_dynamic(code):
    con = db(); c = con.cursor()
    pkg = c.execute("SELECT * FROM profile_packages WHERE code=?", (code,)).fetchone()
    if not pkg: con.close(); abort(404)
    qs_db = c.execute("SELECT * FROM profile_questions WHERE pkg_code=? ORDER BY position,id", (code,)).fetchall()
    questions = []
    for q in qs_db:
        opts = []
        if q["options_json"]:
            try: opts = json.loads(q["options_json"]) 
            except: opts = []
        questions.append({**dict(q), "options": opts})

    ans_rows = c.execute("SELECT question_id, answer_text FROM profile_answers WHERE user_id=? AND pkg_code=?", (session["user_id"], code)).fetchall()
    answers = {f"q_{r['question_id']}": r["answer_text"] for r in ans_rows}

    if request.method == "POST":
        c.execute("DELETE FROM profile_answers WHERE user_id=? AND pkg_code=?", (session["user_id"], code))
        payload = {}
        for q in questions:
            name = f"q_{q['id']}"
            qt = q["q_type"]
            val = ", ".join(request.form.getlist(name)) if qt=="checkbox" else request.form.get(name,"").strip()
            c.execute("INSERT INTO profile_answers(user_id,pkg_code,question_id,answer_text) VALUES (?,?,?,?)",
                      (session["user_id"], code, q["id"], val))
            payload[str(q["id"])] = val
        con.commit(); con.close()
        _award_and_snapshot(session["user_id"], code, payload)
        flash("Ù¾Ø§Ú©ÛØ¬ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§.")
        return redirect(url_for("profile"))
    con.close()
    return render_template("profile_section_dynamic.html", package=pkg, questions=questions, answers=answers)

# ------------ Wallet/Payout ------------
@app.route("/wallet", methods=["GET","POST"]) 
@login_required
def wallet():
    con = db(); c = con.cursor()
    prof = c.execute("SELECT wallet_points FROM profiles WHERE user_id=?", (session["user_id"],)).fetchone()
    tx   = c.execute("SELECT * FROM wallet_transactions WHERE user_id=? ORDER BY id DESC LIMIT 100", (session["user_id"],)).fetchall()
    balance = prof["wallet_points"] if prof else 0
    if request.method == "POST":
        method   = request.form.get("method")
        provider = request.form.get("provider","").strip()
        account  = request.form.get("account","").strip()
        pts      = int(request.form.get("points") or 0)
        min_pts  = int(get_setting("min_payout_points","100"))
        if pts <= 0 or pts > balance or pts < min_pts:
            con.close(); flash("Ú˜Ù…Ø§Ø±Û•ÛŒ Ù¾Û†ÛŒÙ†Øª Ù†Ø§Ø¯Ø±ÙˆØ³ØªÛ• ÛŒØ§Ù† Ú©Û•Ù…ØªØ±Û• Ù„Û• Ù†Û†Ø±Ù…."); return redirect(url_for("wallet"))
        money_per = int(get_setting("money_per_point","10"))
        money_cents = pts * money_per
        con.close()
        add_points(session["user_id"], -pts, "Ù¾ÛØ´Ù†ÛŒØ§Ø²ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†", "spend")
        con = db(); c = con.cursor()
        c.execute("""INSERT INTO payout_requests(user_id,method,provider,account,points,money_cents,status)
                     VALUES (?,?,?,?,?,?, 'pending')""",
                  (session["user_id"], method, provider, account, pts, money_cents))
        con.commit(); con.close()
        flash("Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ù†ÛØ±Ø¯Ø±Ø§ (pending).")
        return redirect(url_for("wallet"))
    con.close()
    providers_bank = ["FIB","CBI","TradeBank","ZiP","HiTR"]
    providers_mobile = ["FastPay","NaxPay","ZainCash","AsiaHawala"]
    return render_template("wallet.html", balance=balance, tx=tx, providers_bank=providers_bank, providers_mobile=providers_mobile)

# ------------ Admin Dashboard ------------
@app.route("/admin") 
@admin_required
def admin_dashboard():
    return render_template("admin_dashboard.html")

# ------------ Admin: CMS Pages ------------
@app.route("/admin/pages")
@admin_required
def admin_pages():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT slug,title,updated_at FROM pages ORDER BY updated_at DESC").fetchall()
    con.close()
    return render_template("admin_pages.html", rows=rows)

@app.route("/admin/pages/new", methods=["GET","POST"])
@admin_required
def admin_page_new():
    if request.method == "POST":
        title = (request.form.get("title") or "").strip()
        slug_in = (request.form.get("slug") or "").strip().lower()
        html = (request.form.get("html") or "").strip()   # â­ Ù†Ø§ÙˆÛŒ Ø®Ø§Ù†Û•Ú©Û• html Ù€Û•

        if not title or not html:
            flash("ØªØ§ÛŒØªÚµ Ùˆ Ù†Ø§ÙˆÛ•Ú•Û†Ú© (HTML) Ù¾ÛÙˆÛŒØ³ØªÙ†.", "error")
            # ÙÛ†Ú•Ù…Û•Ú©Û• Ø¯ÙˆØ¨Ø§Ø±Û• Ù¾ÛŒØ´Ø§Ù†Ø¨Ø¯Û• Ø¨Û Ø¨Ú•Û†ÛŒÛ•ÙˆÛ•
            return render_template("admin_page_new.html", form={"title":title, "slug":slug_in, "html":html})

        slug = slugify(slug_in or title)
        con = db(); c = con.cursor()
        try:
            c.execute("INSERT INTO pages(slug,title,html) VALUES (?,?,?)", (slug, title, html))
            con.commit()
        except sqlite3.IntegrityError as e:
            con.rollback(); con.close()
            flash("Ø¦Û•Ù… slug Ù€Û• Ù¾ÛØ´ØªØ± Ù‡Û•ÛŒÛ•.", "error")
            return render_template("admin_page_new.html", form={"title":title, "slug":slug_in, "html":html})
        con.close()
        flash("Ù¾Û•Ú•Û• Ø¯Ø±ÙˆØ³Øª Ú©Ø±Ø§.")
        return redirect(url_for("admin_pages"))

    return render_template("admin_page_new.html", form={"title":"", "slug":"", "html":""})

@app.route("/admin/pages/<slug>/edit", methods=["GET","POST"])
@admin_required
def admin_page_edit(slug):
    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM pages WHERE slug=?", (slug,)).fetchone()
    if not p:
        con.close(); abort(404)

    if request.method == "POST":
        title = (request.form.get("title") or "").strip()
        html  = (request.form.get("html") or "").strip()  # â­ Ù‡Û•Ù…Ø§Ù† Ù†Ø§Ùˆ
        if not title or not html:
            con.close()
            flash("ØªØ§ÛŒØªÚµ Ùˆ Ù†Ø§ÙˆÛ•Ú•Û†Ú© Ù¾ÛÙˆÛŒØ³ØªÙ†.", "error")
            return render_template("admin_page_edit.html", page=p, form={"title":title or p["title"], "html":html})
        c.execute("UPDATE pages SET title=?, html=?, updated_at=CURRENT_TIMESTAMP WHERE slug=?", (title, html, slug))
        con.commit(); con.close()
        flash("Ù¾Û•Ú•Û• Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")
        return redirect(url_for("admin_pages"))

    form = {"title": p["title"], "html": p["html"]}
    con.close()
    return render_template("admin_page_edit.html", page=p, form=form)
@app.route("/admin/pages/<slug>/delete", methods=["POST"]) 
@admin_required
def admin_page_delete(slug):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM pages WHERE slug=?", (slug,))
    con.commit(); con.close()
    flash("Ù¾Û•Ú•Û• Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("admin_pages"))
@app.route("/admin/surveys/<int:survey_id>/edit", methods=["GET","POST"])
@admin_required
def admin_survey_edit(survey_id):
    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=?", (survey_id,)).fetchone()
    if not s:
        con.close(); abort(404)

    if request.method == "POST":
        title   = (request.form.get("title") or s["title"]).strip()
        desc    = (request.form.get("description") or "").strip()
        try:
            reward  = int(request.form.get("reward_points") or s["reward_points"] or 0)
        except ValueError:
            reward = s["reward_points"] or 0
        allowm  = 1 if request.form.get("allow_multiple") in ("on","1","true") else 0
        is_act  = 1 if request.form.get("is_active") in ("on","1","true") else 0

        c.execute("""UPDATE surveys
                     SET title=?, description=?, reward_points=?, allow_multiple=?, is_active=?
                     WHERE id=?""",
                  (title, desc, reward, allowm, is_act, survey_id))
        con.commit(); con.close()
        flash("Ú•Ø§Ù¾Ø±Ø³ÛŒ Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")
        return redirect(url_for("admin_surveys"))

    con.close()
    return render_template("admin_survey_edit.html", s=s)


# ------------ Admin: Uploads ------------
@app.route("/admin/uploads", methods=["GET","POST"]) 
@admin_required
def admin_uploads():
    if request.method == "POST":
        files = request.files.getlist("files")
        saved = []
        for f in files:
            if f and allowed_file(f.filename):
                name = secure_filename(f.filename)
                base, ext = os.path.splitext(name)
                unique = f"{slugify(base)}-{secrets.token_hex(4)}{ext}"
                f.save(os.path.join(UPLOAD_FOLDER, unique))
                saved.append(unique)
        flash(f"{len(saved)} ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú©Ø±Ø§." if saved else "Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛÚ© Ø¨Ø§Ø±Ù†Û•Ú©Ø±Ø§.")
        return redirect(url_for("admin_uploads"))
    files = []
    for nm in sorted(os.listdir(UPLOAD_FOLDER), reverse=True)[:300]:
        p = os.path.join(UPLOAD_FOLDER, nm)
        if os.path.isfile(p):
            files.append({
                "name": nm,
                "url": url_for("static", filename=f"uploads/{nm}"),
                "size": os.path.getsize(p)
            })
    return render_template("admin_uploads.html", files=files)

@app.route("/admin/uploads/delete", methods=["POST"]) 
@admin_required
def admin_uploads_delete():
    name = os.path.basename(request.form.get("name",""))
    path = os.path.join(UPLOAD_FOLDER, name)
    if os.path.isfile(path):
        os.remove(path); flash("ÙØ§ÛŒÙ„ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.")
    else:
        flash("ÙØ§ÛŒÙ„ Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•.")
    return redirect(url_for("admin_uploads"))

# ------------ Admin: Profile Options (classic lists) ------------
@app.route("/admin/profile-options", methods=["GET","POST"]) 
@admin_required
def admin_profile_options():
    defaults = {
      "degrees": ["Ø¨Û Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û•","Ø³Û•Ø±Û•ØªØ§ÛŒÛŒ","Ù†Ø§ÙˆÛ•Ù†Ø¯ÛŒ","Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛŒ","Ø¯Ø¨Ù„Û†Ù…","Ø¨ÙƒØ§Ù„Û†Ø±ÛŒÛ†Ø³","Ø¯Ø¨Ù„Û†Ù…ÛŒ Ø¨Ø§ÚµØ§","Ù…Ø§Ø³ØªÛ•Ø±","Ø¯ÙƒØªÛ†Ø±Ø§"],
      "cities": ["Ù‡Û•ÙˆÙ„ÛØ±","Ø³Ù„ÛÙ…Ø§Ù†ÛŒ","Ø¯Ù‡Û†Ú©","Ú©Û•Ø±Ú©ÙˆÚ©","Ù…ÙˆÙˆØ³Úµ","Ø¨Û•ØºØ¯Ø§Ø¯","Ø¨Û•ØµØ±Û•","Ù†Û•Ø¬Û•Ù","Ú©Û•Ø±Ø¨Û•Ù„Ø§"],
      "famstat": ["Ø®ÛØ²Ø§Ù†Ø¯Ø§Ø±","Ø³Û•ÚµØª","Ø¬ÛŒØ§Ø¨ÙˆÙˆÛ•ÙˆÛ•","Ù†Û•Ù…Ø§Ù†ÛŒ Ù‡Ø§ÙˆØ³Û•Ø±"],
      "work_types": ["Ø­Ú©ÙˆÙ…ÛŒ","Ø¦Û•Ù‡Ù„ÛŒ","Ø³Û•Ø±Ø¨Û•Ø®Û†","Ø±ÛÚ©Ø®Ø±Ø§ÙˆÛ•ÛŒÛŒ","Ø­Ø²Ø¨ÛŒ","Ù‡ÛŒØªØ±"],
    }
    def get_list_setting_local(key, default_list):
        try:
            raw = get_setting(key)
            if raw:
                arr = json.loads(raw)
                if isinstance(arr, list): return arr
        except Exception: pass
        return default_list

    if request.method == "POST":
        for k in defaults.keys():
            text = (request.form.get(k,"") or "").strip()
            arr = [x.strip() for x in text.split(",") if x.strip()]
            set_setting(f"opt_{k}", json.dumps(arr, ensure_ascii=False))
        flash("Ù‡Û•Ù…ÙˆÙˆ Ø¦Û†Ù¾Ø´Ù†Û•Ú©Ø§Ù† Ù†ÙˆÛÚ©Ø±Ø§Ù†Û•ÙˆÛ•."); return redirect(url_for("admin_profile_options"))
    data = {k: ", ".join(get_list_setting_local(f"opt_{k}", v)) for k, v in defaults.items()}
    return render_template("admin_profile_options.html", data=data)

# ------------ Admin: Dynamic Profile Schema (Packages/Questions CRUD) ------------
@app.route("/admin/profile/schema") 
@admin_required
def admin_profile_schema():
    con = db(); c = con.cursor()
    packages = c.execute("SELECT * FROM profile_packages ORDER BY position, code").fetchall()
    qs = c.execute("SELECT * FROM profile_questions ORDER BY pkg_code, position, id").fetchall()
    questions_by_pkg = {}
    for q in qs:
        pkg = q["pkg_code"]
        options = []
        if q["options_json"]:
            try: options = json.loads(q["options_json"]) 
            except: options = []
        qd = dict(q); qd["options"]=options
        questions_by_pkg.setdefault(pkg, []).append(qd)
    con.close()
    return render_template("admin_profile_schema.html", packages=packages, questions_by_pkg=questions_by_pkg)

@app.route("/admin/profile/packages/new", methods=["GET","POST"]) 
@admin_required
def admin_profile_pkg_new():
    if request.method == "POST":
        title = request.form.get("title","").strip()
        code  = slugify(request.form.get("code","").strip() or title)
        pos   = int(request.form.get("position") or 0)
        if not title: flash("ØªØ§ÙŠØªÚµ Ù¾ÛÙˆÛŒØ³ØªÛ•."); return redirect(url_for("admin_profile_pkg_new"))
        con = db(); c = con.cursor()
        try:
            c.execute("INSERT INTO profile_packages(code,title,position) VALUES (?,?,?)", (code,title,pos))
            con.commit()
        except sqlite3.IntegrityError:
            c.rollback(); con.close(); flash("Ø¦Û•Ù… Ú©Û†Ø¯Û• Ù¾ÛØ´ØªØ± Ù‡Û•ÛŒÛ•."); return redirect(url_for("admin_profile_pkg_new"))
        con.close(); flash("Ù¾Ø§Ú©ÛØ¬ Ø¯Ø±ÙˆØ³Øª Ú©Ø±Ø§."); return redirect(url_for("admin_profile_schema"))
    return render_template("admin_profile_pkg_form.html", mode="new", pkg=None)

@app.route("/admin/profile/packages/<code>/edit", methods=["GET","POST"]) 
@admin_required
def admin_profile_pkg_edit(code):
    con = db(); c = con.cursor()
    pkg = c.execute("SELECT * FROM profile_packages WHERE code=?", (code,)).fetchone()
    if not pkg: con.close(); abort(404)
    if request.method == "POST":
        title = request.form.get("title","").strip()
        pos   = int(request.form.get("position") or 0)
        c.execute("UPDATE profile_packages SET title=?, position=? WHERE code=?", (title,pos,code))
        con.commit(); con.close(); flash("Ù¾Ø§Ú©ÛØ¬ Ù†ÙˆÛ Ú©Ø±Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("admin_profile_schema"))
    con.close(); return render_template("admin_profile_pkg_form.html", mode="edit", pkg=pkg)

# delete package
@app.route("/admin/profile/packages/<code>/delete", methods=["POST"]) 
@admin_required
def admin_profile_pkg_delete(code):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM profile_packages WHERE code=?", (code,))
    con.commit(); con.close()
    flash("Ù¾Ø§Ú©ÛØ¬ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.")
    return redirect(url_for("admin_profile_schema"))

@app.route("/admin/profile/packages/<code>/questions/new", methods=["GET","POST"]) 
@admin_required
def admin_profile_q_new(code):
    con = db(); c = con.cursor()
    pkg = c.execute("SELECT * FROM profile_packages WHERE code=?", (code,)).fetchone()
    if not pkg: con.close(); abort(404)
    if request.method == "POST":
        q_text = request.form.get("q_text","").strip()
        q_type = request.form.get("q_type","text")
        required = 1 if request.form.get("required") in ("1","on","true") else 0
        position = int(request.form.get("position") or 0)
        expose   = 1 if request.form.get("expose_for_rules") in ("1","on","true") else 0
        options  = request.form.get("options","").strip()
        show_if_json = request.form.get("show_if_json", "").strip()
        opts = []
        if q_type in ("select","radio","checkbox"):
            opts = [x.strip() for x in options.split(",") if x.strip()]
        c.execute("""INSERT INTO profile_questions(pkg_code,q_text,q_type,options_json,required,position,expose_for_rules)
                     VALUES (?,?,?,?,?,?,?)""",
                  (code, q_text, q_type, json.dumps(opts, ensure_ascii=False), required, position, expose))
        con.commit(); con.close(); flash("Ù¾Ø±Ø³ÛŒØ§Ø± Ø²ÛŒØ§Ø¯Ú©Ø±Ø§."); return redirect(url_for("admin_profile_schema"))
    con.close(); return render_template("admin_profile_q_form.html", mode="new", pkg=pkg, q=None)

@app.route("/admin/profile/packages/<code>/questions/<int:qid>/edit", methods=["GET","POST"]) 
@admin_required
def admin_profile_q_edit(code, qid):
    con = db(); c = con.cursor()
    pkg = c.execute("SELECT * FROM profile_packages WHERE code=?", (code,)).fetchone()
    q   = c.execute("SELECT * FROM profile_questions WHERE id=? AND pkg_code=?", (qid, code)).fetchone()
    if not pkg or not q: con.close(); abort(404)
    if request.method == "POST":
        q_text = request.form.get("q_text","").strip()
        q_type = request.form.get("q_type","text")
        required = 1 if request.form.get("required") in ("1","on","true") else 0
        position = int(request.form.get("position") or 0)
        expose   = 1 if request.form.get("expose_for_rules") in ("1","on","true") else 0
        options  = request.form.get("options","").strip()
        opts = []
        if q_type in ("select","radio","checkbox"):
            opts = [x.strip() for x in options.split(",") if x.strip()]
        c.execute("""UPDATE profile_questions
                     SET q_text=?, q_type=?, options_json=?, required=?, position=?, expose_for_rules=?
                     WHERE id=? AND pkg_code=?""",
                  (q_text, q_type, json.dumps(opts, ensure_ascii=False), required, position, expose, qid, code))
        con.commit(); con.close(); flash("Ù¾Ø±Ø³ÛŒØ§Ø± Ù†ÙˆÛ Ú©Ø±Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("admin_profile_schema"))
    qd = dict(q)
    try:
        qd["options"] = json.loads(q["options_json"]) if q["options_json"] else []
    except Exception:
        qd["options"] = []
    con.close(); return render_template("admin_profile_q_form.html", mode="edit", pkg=pkg, q=qd)

@app.route("/admin/profile/packages/<code>/questions/<int:qid>/delete", methods=["POST"]) 
@admin_required
def admin_profile_q_delete(code, qid):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM profile_questions WHERE id=? AND pkg_code=?", (qid, code))
    con.commit(); con.close()
    flash("Ù¾Ø±Ø³ÛŒØ§Ø± Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("admin_profile_schema"))

# ------------ Admin: Surveys (with eligibility rules) ------------
@app.route("/admin/surveys") 
@admin_required
def admin_surveys():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT * FROM surveys ORDER BY id DESC").fetchall()
    con.close()
    return render_template("admin_surveys.html", rows=rows)

@app.route("/admin/surveys/new", methods=["GET","POST"]) 
@admin_required
def admin_survey_new():
    if request.method=="POST":
        title = request.form.get("title","").strip()
        desc  = request.form.get("description","").strip()
        reward= int(request.form.get("reward_points") or 10)
        allowm= 1 if request.form.get("allow_multiple")=="on" else 0
        if not title: flash("ØªØ§ÙŠØªÚµ Ù¾ÛÙˆÛŒØ³ØªÛ•."); return redirect(url_for("admin_survey_new"))
        con = db(); c = con.cursor()
        c.execute("""INSERT INTO surveys(title,description,reward_points,allow_multiple,created_by)
                     VALUES (?,?,?,?,?)""", (title,desc,reward,allowm,session["user_id"]))
        con.commit(); con.close(); flash("Ú•Ø§Ù¾Ø±Ø³ÛŒ Ø¯Ø±ÙˆØ³Øª Ú©Ø±Ø§."); return redirect(url_for("admin_surveys"))
    return render_template("admin_survey_new.html")

@app.route("/admin/surveys/<int:survey_id>/toggle", methods=["POST"]) 
@admin_required
def admin_survey_toggle(survey_id):
    con = db(); c = con.cursor()
    c.execute("UPDATE surveys SET is_active = 1 - is_active WHERE id=?", (survey_id,))
    con.commit(); con.close()
    return redirect(url_for("admin_surveys"))

@app.route("/admin/surveys/<int:survey_id>/questions", methods=["GET","POST"]) 
@admin_required
def admin_survey_questions(survey_id):
    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=?", (survey_id,)).fetchone()
    if not s: con.close(); abort(404)
    if request.method=="POST":
        q_text = request.form.get("q_text","").strip()
        q_type = request.form.get("q_type","text")
        required = 1 if request.form.get("required")=="on" else 0
        options  = request.form.get("options","").strip()
        show_if_json = request.form.get("show_if_json","").strip()
        opts = []
        if q_type in ("select","radio","checkbox"):
            opts = [x.strip() for x in options.split(",") if x.strip()]
        pos = c.execute("SELECT COALESCE(MAX(position),0)+1 FROM survey_questions WHERE survey_id=?", (survey_id,)).fetchone()[0]
        c.execute("""INSERT INTO survey_questions(survey_id,q_text,q_type,options_json,required,position,show_if_json)
                     VALUES (?,?,?,?,?,?,?)""", (survey_id, q_text, q_type, json.dumps(opts, ensure_ascii=False), required, pos, show_if_json))
        con.commit()
    qs = c.execute("SELECT * FROM survey_questions WHERE survey_id=? ORDER BY position,id", (survey_id,)).fetchall()
    con.close()
    return render_template("admin_survey_questions.html", survey=s, questions=qs)

@app.route("/admin/surveys/<int:survey_id>/questions/<int:q_id>/delete", methods=["POST"]) 
@admin_required
def admin_survey_q_delete(survey_id, q_id):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM survey_questions WHERE id=? AND survey_id=?", (q_id, survey_id))
    con.commit(); con.close()
    return redirect(url_for("admin_survey_questions", survey_id=survey_id))

@app.route("/admin/surveys/<int:survey_id>/rules", methods=["GET","POST"]) 
@admin_required
def admin_survey_rules(survey_id):
    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=?", (survey_id,)).fetchone()
    if not s: con.close(); abort(404)
    row = c.execute("SELECT rules_json FROM survey_eligibility WHERE survey_id=?", (survey_id,)).fetchone()
    rules = json.loads(row["rules_json"]) if row else {}

    # use ALL profile questions (no expose filter)
    fields = []
    pq = c.execute("""SELECT q.*, p.title AS pkg_title
                      FROM profile_questions q
                      JOIN profile_packages p ON p.code=q.pkg_code
                      ORDER BY p.position, q.position, q.id""").fetchall()
    for q in pq:
        f = {"key": f"q_{q['id']}", "label": f"{q['pkg_title']} â€” {q['q_text']}", "type": q["q_type"]}
        try:
            f["options"] = json.loads(q["options_json"]) if q["options_json"] else []
        except Exception:
            f["options"] = []
        fields.append(f)
    con.close()

    if request.method == "POST":
        def arr(name): return [x.strip() for x in request.form.get(name,"").split(",") if x.strip()]
        data = {
            "min_age": int(request.form.get("min_age")) if request.form.get("min_age") else None,
            "max_age": int(request.form.get("max_age")) if request.form.get("max_age") else None,
            "degrees": arr("degrees"),
            "cities": arr("cities"),
            "family_status": arr("family_status"),
            "work_types": arr("work_types"),
            "gender": request.form.get("gender"),
            "political_member": request.form.get("political_member"),
            "advanced_rules_json": json.loads(request.form.get("advanced_rules_json","[]") or "[]"),
        }
        data = {k:v for k,v in data.items() if v not in (None, "", [])}

        coni = db(); ci = coni.cursor()
        if row:
            ci.execute("UPDATE survey_eligibility SET rules_json=? WHERE survey_id=?", (json.dumps(data, ensure_ascii=False), survey_id))
        else:
            ci.execute("INSERT INTO survey_eligibility(survey_id,rules_json) VALUES (?,?)", (survey_id, json.dumps(data, ensure_ascii=False)))
        coni.commit(); coni.close()
        flash("Ù…Û•Ø±Ø¬Û•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.")
        return redirect(url_for("admin_surveys"))

    return render_template("admin_survey_rules.html", survey=s, rules=rules, rule_fields=fields)

# ------------ Eligibility helpers ------------
def profile_core(user_id):
    con = db(); c = con.cursor()
    p = c.execute("SELECT * FROM profiles WHERE user_id=?", (user_id,)).fetchone()
    con.close()
    return dict(p) if p else {}

def get_answer_map(user_id):
    con = db(); c = con.cursor()
    rows = c.execute("SELECT question_id, answer_text FROM profile_answers WHERE user_id=?", (user_id,)).fetchall()
    con.close()
    return {f"q_{r['question_id']}": (r["answer_text"] or "") for r in rows}

def has_min_profile(user_id):
    # legacy checker (not used for survey eligibility anymore)
    p = profile_core(user_id)
    need = ["age","degree","city","political_member","gender"]
    return all(p.get(k) not in (None, "", 0) for k in need)

def eval_advanced_rules(user_id, adv_rules):
    if not adv_rules: return True
    amap = get_answer_map(user_id)

    def match(rule):
        key = rule.get("key"); op = rule.get("op"); val = rule.get("val")
        ans = amap.get(key, "")
        if op == "=":
            return ans == str(val)
        if op == "in":
            if isinstance(val, list):
                return ans in [str(v) for v in val]
            return ans in [v.strip() for v in str(val).split(",")]
        if op == ">=":
            try: return float(ans) >= float(val)
            except: return False
        if op == "<=":
            try: return float(ans) <= float(val)
            except: return False
        if op == "contains":
            return str(val) in ans
        return True

    return all(match(r) for r in adv_rules)

def eligible(user_id, survey_id):
    con = db(); c = con.cursor()
    row = c.execute("SELECT rules_json FROM survey_eligibility WHERE survey_id=?", (survey_id,)).fetchone()
    con.close()
    if not row:
        return True, None
    rules = json.loads(row["rules_json"] or "{}")
    p  = profile_core(user_id)

    def ck_age():
        if "min_age" in rules and (not p.get("age") or int(p["age"]) < int(rules["min_age"])): return False
        if "max_age" in rules and (not p.get("age") or int(p["age"]) > int(rules["max_age"])): return False
        return True
    def ck_in(key, arr):
        if not arr: return True
        return (p.get(key) in arr)
    def ck_gender():
        g = rules.get("gender")
        if not g or g=="Ù‡Û•Ø±Ø¯ÙˆÙˆ": return True
        return p.get("gender")==g
    def ck_pol():
        g = rules.get("political_member")
        if not g or g=="Ù‡Û•Ø±Ø¯ÙˆÙˆ": return True
        return p.get("political_member")==g

    simple_ok = (
        ck_age() and
        ck_in("degree", rules.get("degrees", [])) and
        ck_in("city", rules.get("cities", [])) and
        ck_in("family_status", rules.get("family_status", [])) and
        ck_in("work_type", rules.get("work_types", [])) and
        ck_gender() and
        ck_pol()
    )

    adv_ok = eval_advanced_rules(user_id, rules.get("advanced_rules_json"))

    return simple_ok and adv_ok, rules

# ------------ Survey Fill ------------
@app.route("/surveys/<int:survey_id>/fill", methods=["GET","POST"]) 
@login_required
def survey_fill(survey_id):
    # NEW: require ALL profile packages completed
    ok_pkg, missing = completed_all_packages(session["user_id"]) 
    if not ok_pkg:
        flash("ØªÚ©Ø§ÛŒÛ• Ø³Û•Ø±Û•ØªØ§ Ù‡Û•Ù…ÙˆÙˆ Ù¾Ø§Ú©ÛØ¬Û•Ú©Ø§Ù†ÛŒ Ù¾Ú•Û†ÙØ§ÛŒÙ„ Ù¾Ú•Ø¨Ú©Û•ÙˆÛ•.")
        return redirect(url_for("profile"))

    ok, _rules = eligible(session["user_id"], survey_id)
    if not ok:
        flash("Ø¨Ø¨ÙˆØ±Û•ØŒ Ù…Û•Ø±Ø¬Û•Ú©Ø§Ù†Øª Ù¾Ú• Ù†Ø§Ú©Ø§Øª Ø¨Û† Ø¦Û•Ù… Ú•Ø§Ù¾Ø±Ø³ÛŒÛŒÛ•.")
        return redirect(url_for("surveys_page"))

    con = db(); c = con.cursor()
    s = c.execute("SELECT * FROM surveys WHERE id=? AND is_active=1", (survey_id,)).fetchone()
    if not s: con.close(); abort(404)

    if not s["allow_multiple"]:
        ex = c.execute("SELECT 1 FROM survey_responses WHERE survey_id=? AND user_id=?", (survey_id, session["user_id"])).fetchone()
        if ex:
            con.close(); flash("ØªÛ† Ù¾ÛØ´ØªØ± Ø¦Û•Ù… Ú•Ø§Ù¾Ø±Ø³ÛŒÛŒÛ•Øª Ù¾Ú•Ú©Ø±Ø¯ÙˆÙˆÛ•."); return redirect(url_for("surveys_page"))

    qs_db = c.execute("SELECT * FROM survey_questions WHERE survey_id=? ORDER BY position,id", (survey_id,)).fetchall()
    questions = []
    for q in qs_db:
        opts = []
        if q["options_json"]:
            try: opts = json.loads(q["options_json"]) 
            except: opts = []
        questions.append({**dict(q), "options": opts})

    if request.method == "POST":
        c.execute("INSERT INTO survey_responses(survey_id,user_id) VALUES (?,?)", (survey_id, session["user_id"]))
        rid = c.lastrowid
        for q in questions:
            name = f"q{q['id']}"
            qt = q["q_type"]
            val = ", ".join(request.form.getlist(name)) if qt=="checkbox" else request.form.get(name,"").strip()
            c.execute("INSERT INTO survey_response_items(response_id,question_id,answer_text) VALUES (?,?,?)",
                      (rid, q["id"], val))
        con.commit()
        pts = int(s["reward_points"] or 0)
        con.close()
        if pts:
            add_points(session["user_id"], pts, f"Ù¾Ú•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú•Ø§Ù¾Ø±Ø³ÛŒ #{s['id']}", "earn")
        return render_template("survey_thanks.html", survey=s, reward_points=pts)

    con.close()
    return render_template("survey_fill.html", survey=s, questions=questions)

# ------------ Admin: Ads / Games ------------
@app.route("/admin/ads", methods=["GET","POST"]) 
@admin_required
def admin_ads():
    con = db(); c = con.cursor()
    if request.method=="POST":
        title = request.form.get("title","").strip()
        image = request.form.get("image_url","").strip()
        link  = request.form.get("link_url","").strip()
        # Ù¾Û†ÛŒÙ†ØªÛŒ Ù†ÙˆÛ Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•
        reward_points = int(request.form.get("reward_points", get_setting("pts_ad_view","2")))
        c.execute("INSERT INTO ads(title,image_url,link_url,reward_points) VALUES (?,?,?,?)", 
                  (title,image,link,reward_points))
        con.commit()
    rows = c.execute("SELECT * FROM ads ORDER BY id DESC").fetchall()
    con.close()
    return render_template("admin_ads.html", rows=rows)
# ÙÛ•Ù†Ú©Ø´Ù†ÛŒ Ù†ÙˆÛ Ø¨Û† Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•ÛÚ©Ù„Ø§Ù…
@app.route("/admin/ads/<int:ad_id>/edit", methods=["GET","POST"]) 
@admin_required
def admin_ads_edit(ad_id):
    con = db(); c = con.cursor()
    ad = c.execute("SELECT * FROM ads WHERE id=?", (ad_id,)).fetchone()
    if not ad:
        con.close(); abort(404)
    
    if request.method == "POST":
        title = request.form.get("title","").strip()
        image = request.form.get("image_url","").strip()
        link  = request.form.get("link_url","").strip()
        reward_points = int(request.form.get("reward_points", 2))
        
        c.execute("""UPDATE ads 
                     SET title=?, image_url=?, link_url=?, reward_points=? 
                     WHERE id=?""", 
                  (title, image, link, reward_points, ad_id))
        con.commit(); con.close()
        flash("Ú•ÛÚ©Ù„Ø§Ù… Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")
        return redirect(url_for("admin_ads"))
    
    con.close()
    return render_template("admin_ad_edit.html", ad=ad)

@app.route("/admin/ads/<int:ad_id>/toggle", methods=["POST"]) 
@admin_required
def admin_ad_toggle(ad_id):
    con = db(); c = con.cursor()
    c.execute("UPDATE ads SET is_active = 1 - is_active WHERE id=?", (ad_id,))
    con.commit(); con.close()
    return redirect(url_for("admin_ads"))

@app.route("/admin/ads/<int:ad_id>/delete", methods=["POST"]) 
@admin_required
def admin_ad_delete(ad_id):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM ads WHERE id=?", (ad_id,))
    con.commit(); con.close()
    return redirect(url_for("admin_ads"))

@app.route("/admin/games", methods=["GET","POST"]) 
@admin_required
def admin_games():
    con = db(); c = con.cursor()
    if request.method=="POST":
        title = request.form.get("title","").strip()
        embed = request.form.get("embed_url","").strip()
        c.execute("INSERT INTO games(title,embed_url) VALUES (?,?)", (title,embed))
        con.commit()
    rows = c.execute("SELECT * FROM games ORDER BY id DESC").fetchall()
    con.close()
    return render_template("admin_games.html", rows=rows)

@app.route("/admin/games/<int:game_id>/toggle", methods=["POST"]) 
@admin_required
def admin_game_toggle(game_id):
    con = db(); c = con.cursor()
    c.execute("UPDATE games SET is_active = 1 - is_active WHERE id=?", (game_id,))
    con.commit(); con.close()
    return redirect(url_for("admin_games"))

@app.route("/admin/games/<int:game_id>/delete", methods=["POST"]) 
@admin_required
def admin_game_delete(game_id):
    con = db(); c = con.cursor()
    c.execute("DELETE FROM games WHERE id=?", (game_id,))
    con.commit(); con.close()
    return redirect(url_for("admin_games"))

# ------------ Admin: Payout moderation ------------
@app.route("/admin/payouts", methods=["GET","POST"]) 
@admin_required
def admin_payouts():
    con = db(); c = con.cursor()
    if request.method == "POST":
        pid = int(request.form.get("pid"))
        action = request.form.get("action")
        row = c.execute("SELECT * FROM payout_requests WHERE id=?", (pid,)).fetchone()
        if row and row["status"]=="pending":
            if action=="approve":
                c.execute("UPDATE payout_requests SET status='approved', processed_at=CURRENT_TIMESTAMP WHERE id=?", (pid,))
                add_points(row["user_id"], 0, f"Ù¾Ø§Ø±Û•Ø¯Ø§Ù† ØªØ§ÛŒÛŒØ¯ Ú©Ø±Ø§ ({row['points']} pts â†’ {row['money_cents']} IQD)", "payout")
            elif action=="reject":
                add_points(row["user_id"], row["points"], "Ú•Û•Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† (Ú¯Û•Ú•Ø§Ù†Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù¾Û†ÛŒÙ†Øª)", "adjust")
                c.execute("UPDATE payout_requests SET status='rejected', processed_at=CURRENT_TIMESTAMP WHERE id=?", (pid,))
            con.commit()
    rows = c.execute("SELECT pr.*, u.username FROM payout_requests pr LEFT JOIN users u ON u.id=pr.user_id ORDER BY id DESC").fetchall()
    con.close()
    return render_template("admin_payouts.html", rows=rows)

# ------------ Admin: Wallet Adjust (ADMIN ONLY manual points) ------------
@app.route("/admin/wallet/adjust", methods=["GET","POST"]) 
@admin_required
def admin_wallet_adjust():
    if request.method == "POST":
        ident = (request.form.get("ident","") or "").strip().lower()  # username ÛŒØ§Ù† email
        pts   = int(request.form.get("points") or 0)
        note  = (request.form.get("note","") or "").strip() or "manual adjust"
        con = db(); c = con.cursor()
        u = c.execute("SELECT id,username,email FROM users WHERE lower(username)=? OR lower(email)=?",
                      (ident, ident)).fetchone()
        if not u:
            con.close(); flash("Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø± Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•."); return redirect(url_for("admin_wallet_adjust"))
        uid = u["id"]
        con.close()
        add_points(uid, pts, note, "adjust")
        flash(f"Ù¾Û†ÛŒÙ†Øª {pts:+} Ø¨Û† @{u['username']} Ø²ÛŒØ§Ø¯/Ú©Û•Ù… Ú©Ø±Ø§.")
        return redirect(url_for("admin_wallet_adjust"))

    # recent transactions
    con = db(); c = con.cursor()
    tx = c.execute("""
      SELECT wt.*, u.username
      FROM wallet_transactions wt
      LEFT JOIN users u ON u.id = wt.user_id
      ORDER BY wt.id DESC LIMIT 50
    """).fetchall()
    con.close()
    return render_template("admin_wallet_adjust.html", tx=tx)

# ------------ Admin: Settings (set 1 point = X IQD, etc.) ------------
@app.route("/admin/settings", methods=["GET","POST"]) 
@admin_required
def admin_settings():
    keys = ["money_per_point","min_payout_points","pts_profile_section","pts_ad_view","pts_game_play"]
    if request.method == "POST":
        for k in keys:
            v = (request.form.get(k,"") or "").strip()
            if v != "":
                set_setting(k, v)
        flash("Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.")
        return redirect(url_for("admin_settings"))

    data = {k:int(get_setting(k,"0")) for k in keys}
    return render_template("admin_settings.html", data=data)

# ------------ Error ------------
@app.errorhandler(404)
def not_found(e):
    return render_template("404.html"), 404
# === FIX: ensure /admin/games/<id>/edit exists ===
if 'admin_games_edit' not in app.view_functions:
    # [REMOVED] duplicate decorator for /admin/games/<int:game_id>/edit
    @admin_required
    def admin_games_edit_legacy_removed(game_id):
        con = db(); c = con.cursor()
        g = c.execute("SELECT * FROM games WHERE id=?", (game_id,)).fetchone()
        if not g:
            con.close()
            abort(404)

        if request.method == "POST":
            title = (request.form.get("title") or "").strip()
            play_url = (request.form.get("play_url") or "").strip()
            embed_html = request.form.get("embed_html") or ""
            thumbnail = (request.form.get("thumbnail_url") or "").strip()
            pts = request.form.get("points_override")
            secs = request.form.get("min_seconds_override")
            points_override = None if pts in (None, "", "None") else max(0, int(pts))
            min_seconds_override = None if secs in (None, "", "None") else max(0, int(secs))

            if not title:
                con.close()
                flash("ØªØ§ÙŠØªÚµ Ù¾ÛÙˆÛŒØ³ØªÛ•.")
                return redirect(url_for("admin_games_edit", game_id=game_id))

            c.execute("""
                UPDATE games SET title=?, play_url=?, embed_html=?, thumbnail_url=?,
                                 points_override=?, min_seconds_override=?
                WHERE id=?""",
                (title, play_url, embed_html, thumbnail, points_override, min_seconds_override, game_id))
            con.commit()
            con.close()
            flash("Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§.")
            return redirect(url_for("admin_games_edit", game_id=game_id))

        default_pts  = int(get_setting("games_points_per_play", "5") or 5)
        default_secs = int(get_setting("games_min_seconds", "30") or 30)
        maps = c.execute("""
            SELECT ga.position, a.id AS ad_id, a.title AS ad_title
            FROM game_ads ga JOIN ads a ON a.id = ga.ad_id
            WHERE ga.game_id = ?""", (game_id,)).fetchall()
        all_ads = c.execute("SELECT id, title FROM ads ORDER BY id DESC").fetchall()
        con.close()

        try:
            return render_template("admin_games_edit.html",
                                   g=g, default_pts=default_pts, default_secs=default_secs,
                                   maps=maps, all_ads=all_ads)
        except Exception:
            return f"<!doctype html><meta charset='utf-8'><h3>Edit Game #{g['id']}</h3>"
# ===== Debug helpers (safe to add multiple times) =====
def ensure_debug_routes(app):
    if "_routes" not in app.view_functions:
        @app.route("/_routes")
        def _routes():
            rows = []
            for r in app.url_map.iter_rules():
                methods = ",".join(sorted(m for m in r.methods if m in
                                          ("GET","POST","PUT","PATCH","DELETE","OPTIONS")))
                rows.append(f"{r.rule:40} â†’ endpoint={r.endpoint}  [{methods}]")
            return "<pre>" + "\n".join(sorted(rows)) + "</pre>"

    if "healthz" not in app.view_functions:
        @app.route("/healthz")
        def healthz():
            return "ok", 200
# --- Alias/fallback for admin_pages_list ---
if "admin_pages_list" not in app.view_functions:
    @app.route("/admin/pages", endpoint="admin_pages_list")
    def _admin_pages_list_alias():
        # Ø¦Û•Ú¯Û•Ø± api_pages_list Ù‡Û•Ø¨ÙˆÙˆØŒ Ù‡Û•Ù…Ø§Ù†Û• Ø¨Ø§Ù†Ú¯ Ø¨Ú©Û•
        if "api_pages_list" in app.view_functions:
            return app.view_functions["api_pages_list"]()

        # fallback: Ù‡Û•ÙˆÚµÛŒ Ù„ÛŒØ³ØªÚ©Ø±Ø¯Ù†ÛŒ pages Ù„Û• DB Ø¨Ú©Û•
        rows = []
        try:
            with db() as con:
                rows = con.execute(
                    "SELECT id, slug, title, updated_at FROM pages ORDER BY updated_at DESC, id DESC"
                ).fetchall()
        except Exception:
            pass

        from flask import render_template_string
        items = "".join(
            f"<tr><td>{r['id']}</td>"
            f"<td><a href='/p/{r['slug']}' target='_blank'>{r['slug']}</a></td>"
            f"<td>{r['title']}</td>"
            f"<td>{r['updated_at']}</td></tr>"
            for r in rows
        ) or "<tr><td colspan='4'>Ù‡ÛŒÚ† Ù¾Û•Ú•Û•ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•.</td></tr>"

        return render_template_string(f"""
<!doctype html><meta charset="utf-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<div class="container py-4" style="max-width:1000px">
  <div class="d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Design â€” Ù¾Û•Ú•Û•Ú©Ø§Ù†</h4>
    <div><a class="btn btn-sm btn-primary" href="{{{{ url_for('admin_page_new') if 'admin_page_new' in current_app.view_functions else '#' }}}}">+ Ù¾Û•Ú•Û•ÛŒ Ù†ÙˆÛ</a></div>
  </div>
  <hr>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead><tr><th>ID</th><th>Slug</th><th>Title</th><th>Updated</th></tr></thead>
      <tbody>{items}</tbody>
    </table>
  </div>
</div>
""")

# call it once after routes are defined
ensure_debug_routes(app)
# ===== end debug helpers =====
# ==== FIX: toggle endpoint for games (admin_games_toggle vs admin_game_toggle) ====
from flask import current_app

# Ú•ÙˆÙˆØªÛŒ Ø¨Ù†Ú†ÛŒÙ†Û•ÛŒ toggle Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ•ØŒ Ø¯Ø±ÙˆØ³ØªÛŒ Ø¨Ú©Û•
if 'admin_game_toggle' not in app.view_functions:
    @app.route("/admin/games/<int:game_id>/toggle", methods=["POST"])
    @admin_required
    def admin_game_toggle(game_id):
        con = db(); c = con.cursor()
        g = c.execute("SELECT is_active FROM games WHERE id=?", (game_id,)).fetchone()
        if not g:
            con.close()
            abort(404)
        new_state = 0 if g["is_active"] else 1
        c.execute("UPDATE games SET is_active=? WHERE id=?", (new_state, game_id))
        con.commit(); con.close()
        flash("Ø¯Û†Ø®ÛŒ ÛŒØ§Ø±ÛŒ Ú¯Û†Ú•Ø¯Ø±Ø§.")
        return redirect(url_for("admin_games"))

# Ø¦Û•Ù„ÛŒØ§Ø³: Ø¦Û•Ú¯Û•Ø± Ù‚Ø§Ù„ÛŒØ¨ Ø¨Ø§Ù†Ú¯ Ø¨Ú©Ø§Øª admin_games_toggleØŒ Ø¦Û•Ù…Û•Ø´ Ú©Ø§Ø± Ø¯Û•Ú©Ø§Øª Ø¨Û Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù‚Ø§Ù„ÛŒØ¨
if 'admin_games_toggle' not in app.view_functions:
    @app.route("/__alias/admin/games/<int:game_id>/toggle", endpoint="admin_games_toggle", methods=["POST"])
    @admin_required
    def __alias_admin_games_toggle(game_id):
        return current_app.view_functions['admin_game_toggle'](game_id)
# ==== /FIX ====
# ==== FIX: admin_game_toggle / admin_games_toggle ====
from flask import current_app

# Ú•ÙˆÙˆØªÛŒ Ø¨Ù†Ú†ÛŒÙ†Û•ÛŒ toggle (POST) â€” Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ• Ø¯Ø±ÙˆØ³ØªÛŒ Ø¨Ú©Û•
if 'admin_game_toggle' not in app.view_functions:
    @app.route("/admin/games/<int:game_id>/toggle", methods=["POST"])
    @admin_required
    def admin_game_toggle(game_id):
        con = db(); c = con.cursor()
        row = c.execute("SELECT is_active FROM games WHERE id=?", (game_id,)).fetchone()
        if not row:
            con.close(); abort(404)
        new_state = 0 if row["is_active"] else 1
        c.execute("UPDATE games SET is_active=? WHERE id=?", (new_state, game_id))
        con.commit(); con.close()
        flash("Ø¯Û†Ø®ÛŒ ÛŒØ§Ø±ÛŒ Ú¯Û†Ú•Ø¯Ø±Ø§.")
        return redirect(url_for("admin_games"))

# alias Ø¨Û† Ù‚Ø§Ù„ÛŒØ¨Û•Ú©Ø§Ù†ÛŒ Ú©Û†Ù† Ú©Û• Ø¨Ø§Ù†Ú¯ Ø¯Û•Ú©Û•Ù† admin_games_toggle
if 'admin_games_toggle' not in app.view_functions:
    @app.route("/__alias/admin/games/<int:game_id>/toggle", endpoint="admin_games_toggle", methods=["POST"])
    @admin_required
    def __alias_admin_games_toggle(game_id):
        return current_app.view_functions['admin_game_toggle'](game_id)

# ==== FIX: admin_game_delete / admin_games_delete ====

# Ú•ÙˆÙˆØªÛŒ Ø¨Ù†Ú†ÛŒÙ†Û•ÛŒ Ø³Ú•ÛŒÙ†Û•ÙˆÛ• (POST) â€” Ø¯Û•Ø¨Ø§ØªÛ• admin_games Ù„ÛŒØ³ØªÛ•Ú©Û•ÙˆÛ•
if 'admin_game_delete' not in app.view_functions:
    @app.route("/admin/games/<int:game_id>/delete", methods=["POST"])
    @admin_required
    def admin_game_delete(game_id):
        con = db(); c = con.cursor()
        # Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù‡Ø§ÙˆÙ¾ÛÚ†Û•Ú©Ø§Ù† Ø¨Û† Ø¦Û•Ùˆ ÛŒØ§Ø±ÛŒÛ•
        try:
            c.execute("DELETE FROM game_ads   WHERE game_id=?", (game_id,))
        except Exception:
            pass
        try:
            c.execute("DELETE FROM game_plays WHERE game_id=?", (game_id,))
        except Exception:
            pass
        # Ø®ÙˆØ¯ÛŒ ÛŒØ§Ø±ÛŒ
        c.execute("DELETE FROM games WHERE id=?", (game_id,))
        con.commit(); con.close()
        flash("ÛŒØ§Ø±ÛŒ Ø¨Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.")
        return redirect(url_for("admin_games"))

# alias Ø¨Û† Ù†Ø§ÙˆÛŒ Ú©Û†Ù†: admin_games_delete
if 'admin_games_delete' not in app.view_functions:
    @app.route("/__alias/admin/games/<int:game_id>/delete", endpoint="admin_games_delete", methods=["POST"])
    @admin_required
    def __alias_admin_games_delete(game_id):
        return current_app.view_functions['admin_game_delete'](game_id)
# ===== RESCUE PATCH: ensure routes exist & add debug helpers =====
import os, sqlite3
from datetime import date, datetime, timezone
from functools import wraps
from flask import (current_app, render_template, request, redirect, url_for,
                   flash, session, abort)

# 1) Debug helpers: /_routes + /healthz (ØªÛ•Ù†ÛŒØ§ Ø¦Û•Ú¯Û•Ø± Ø¨ÙˆÙˆÙ†ÛŒØ§Ù† Ù†ÛŒÛŒÛ•)
def _ensure_debug_routes(app):
    if "_routes" not in app.view_functions:
        @app.route("/_routes")
        def _routes():
            rows = []
            for r in app.url_map.iter_rules():
                methods = ",".join(sorted(m for m in r.methods if m in
                                          ("GET","POST","PUT","PATCH","DELETE","OPTIONS")))
                rows.append(f"{r.rule:40} â†’ endpoint={r.endpoint}  [{methods}]")
            return "<pre>" + "\n".join(sorted(rows)) + "</pre>"
    if "healthz" not in app.view_functions:
        @app.route("/healthz")
        def healthz(): return "ok", 200
_ensure_debug_routes(app)

# 2) Dev sessions (local): /dev/admin , /dev/user (Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ•)
if "dev_admin" not in app.view_functions:
    @app.route("/dev/admin")
    def dev_admin():
        session["user_id"] = 1
        session["is_admin"] = True
        flash("Dev admin session set.")
        return redirect(url_for("home") if "home" in app.view_functions else "/")

if "dev_user" not in app.view_functions:
    @app.route("/dev/user")
    def dev_user():
        session["user_id"] = 2
        session["is_admin"] = False
        flash("Dev user session set.")
        return redirect(url_for("home") if "home" in app.view_functions else "/")

# 3) Fallback home Ø¦Û•Ú¯Û•Ø± Ù†Û•Ø¨ÙˆÙˆ
if "home" not in app.view_functions:
    @app.route("/")
    def home():
        return """<!doctype html><meta charset='utf-8'>
        <div style="font-family:system-ui;max-width:860px;margin:48px auto">
          <h2>SurveyApp</h2>
          <p>Server is running.</p>
          <ul>
            <li><a href="/dev/admin">/dev/admin</a> (set admin)</li>
            <li><a href="/dev/user">/dev/user</a> (set user)</li>
            <li><a href="/_routes">/_routes</a></li>
            <li><a href="/earn/ads">/earn/ads</a></li>
            <li><a href="/earn/games">/earn/games</a></li>
            <li><a href="/admin/ads-earn-settings">/admin/ads-earn-settings</a></li>
          </ul>
        </div>"""

# 4) HelpersÛŒ Ø®Ø§ÚµÛŒ (ØªÛ•Ù†ÛŒØ§ Ø¨Û† ÙÛ†ÚµØ¨Û•Ú©): DB + settings (Ù†Ø§ÙˆÛŒØ§Ù† ÛŒÛ•Ú©ØªØ§Ø²Û•ÛŒÛ• Ø¨Û† Ù†Ø§Ú©Û†Ú©ÛŒ)
BASE_DIR = os.path.dirname(__file__)
_DB_PATH = os.path.join(BASE_DIR, "survey.db")
def _db():
    con = sqlite3.connect(_DB_PATH); con.row_factory = sqlite3.Row
    return con

def _ensure_settings_table():
    con = _db(); c = con.cursor()
    c.execute("CREATE TABLE IF NOT EXISTS app_settings(key TEXT PRIMARY KEY, value TEXT)")
    con.commit(); con.close()
_ensure_settings_table()

def _get_setting(k, d=None):
    con = _db(); c = con.cursor()
    r = c.execute("SELECT value FROM app_settings WHERE key=?", (k,)).fetchone()
    con.close()
    return (r["value"] if r else d)

def _set_setting(k, v):
    con = _db(); c = con.cursor()
    if c.execute("SELECT 1 FROM app_settings WHERE key=?", (k,)).fetchone():
        c.execute("UPDATE app_settings SET value=? WHERE key=?", (str(v), k))
    else:
        c.execute("INSERT INTO app_settings(key,value) VALUES (?,?)", (k, str(v)))
    con.commit(); con.close()

# 5) DecoratorsÛŒ ÙÛ†ÚµØ¨Û•Ú© (Ø¦Û•Ú¯Û•Ø± Ù„Û•Ø³Û•Ø±Û•ÙˆÛ• Ù¾ÛÙ†Ø§Ø³Û• Ù†Û•Ú©Ø±Ø§ÙˆÙ†)
def _login_required(fn):
    @wraps(fn)
    def w(*a, **kw):
        if not session.get("user_id"):
            flash("ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.")
            return redirect(url_for("home") if "home" in app.view_functions else "/")
        return fn(*a, **kw)
    return w

def _admin_required(fn):
    @wraps(fn)
    def w(*a, **kw):
        if not session.get("user_id"):
            flash("ØªÚ©Ø§ÛŒÛ• Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.")
            return redirect(url_for("home") if "home" in app.view_functions else "/")
        if not session.get("is_admin"):
            abort(403)
        return fn(*a, **kw)
    return w

# 6) /earn/ads  â€” ØªÛ•Ù†ÛŒØ§ Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ• Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•
if "earn_ads_list" not in app.view_functions:
    # Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù†Û•Ú©Ø§Ù†ÛŒ Ù¾ÛÙˆÛŒØ³Øª Ø¨Û† Ads
    con = _db(); c = con.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS ads(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        image_url TEXT,
        link_url TEXT,
        is_active INTEGER NOT NULL DEFAULT 1,
        points_override INTEGER,
        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    )""")
    c.execute("""CREATE TABLE IF NOT EXISTS ad_views(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        ad_id INTEGER NOT NULL,
        viewed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
        view_date TEXT NOT NULL,
        UNIQUE(user_id, ad_id, view_date)
    )""")
    # Ø¨Û•Ù‡Ø§ÛŒ Ø¨Ù†Û•Ú•Û•ØªÛŒ
    if _get_setting("ads_daily_quota") is None: _set_setting("ads_daily_quota","10")
    if _get_setting("ads_points_per_view") is None: _set_setting("ads_points_per_view","2")
    if _get_setting("ads_view_min_seconds") is None: _set_setting("ads_view_min_seconds","10")
    con.commit(); con.close()

    @app.route("/earn/ads")
    @_login_required
    def earn_ads_list():
        try:
            return render_template("earn_ads.html")
        except Exception:
            # ÙÛ†ÚµØ¨Û•Ú© HTML
            dq = int(_get_setting("ads_daily_quota","10") or 10)
            pp = int(_get_setting("ads_points_per_view","2") or 2)
            ms = int(_get_setting("ads_view_min_seconds","10") or 10)
            return f"""<!doctype html><meta charset='utf-8'>
            <h3 style="font-family:system-ui">Earn Ads</h3>
            <p>Daily quota: {dq} â€” Points per view: {pp} â€” Min seconds: {ms}</p>
            <p>Ù‡ÛŒÚ† Ù‚Ø§Ù„Ø¨ÛŒ ØªØ§ÛŒØ¨Û•Øª Ù†ÛŒÛŒÛ•Ø› Ø¦Û•Ù… ÙÛ†ÚµØ¨Û•Ú©Û• Ú©Ø§Ø± Ø¯Û•Ú©Ø§Øª.</p>"""

# 7) /earn/games  â€” ØªÛ•Ù†ÛŒØ§ Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ• Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•
if "earn_games_list" not in app.view_functions:
    con = _db(); c = con.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS games(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        play_url TEXT,
        embed_html TEXT,
        thumbnail_url TEXT,
        is_active INTEGER NOT NULL DEFAULT 1,
        points_override INTEGER,
        min_seconds_override INTEGER,
        created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    )""")
    c.execute("""CREATE TABLE IF NOT EXISTS game_plays(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        game_id INTEGER NOT NULL,
        played_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
        play_date TEXT NOT NULL,
        UNIQUE(user_id, game_id, play_date)
    )""")
    if _get_setting("games_daily_quota") is None: _set_setting("games_daily_quota","10")
    if _get_setting("games_points_per_play") is None: _set_setting("games_points_per_play","5")
    if _get_setting("games_min_seconds") is None: _set_setting("games_min_seconds","30")
    con.commit(); con.close()

    @app.route("/earn/games")
    @_login_required
    def earn_games_list():
        try:
            return render_template("earn_games.html")
        except Exception:
            dq = int(_get_setting("games_daily_quota","10") or 10)
            pp = int(_get_setting("games_points_per_play","5") or 5)
            ms = int(_get_setting("games_min_seconds","30") or 30)
            return f"""<!doctype html><meta charset='utf-8'>
            <h3 style="font-family:system-ui">Earn Games</h3>
            <p>Daily quota: {dq} â€” Points per play: {pp} â€” Min seconds: {ms}</p>
            <p>Ù‡ÛŒÚ† Ù‚Ø§Ù„Ø¨ÛŒ ØªØ§ÛŒØ¨Û•Øª Ù†ÛŒÛŒÛ•Ø› ÙÛ†ÚµØ¨Û•Ú© Ù¾ÛŒØ´Ø§Ù†ÛŒ Ø¯Û•Ø¯Ø±ÛØª.</p>"""

# 8) /admin/ads-earn-settings â€” ØªÛ•Ù†ÛŒØ§ Ø¦Û•Ú¯Û•Ø± Ù†ÛŒÛŒÛ• Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•
if "admin_ads_earn_settings" not in app.view_functions:
    @app.route("/admin/ads-earn-settings", methods=["GET","POST"])
    @_admin_required
    def admin_ads_earn_settings():
        if request.method == "POST":
            try:
                _set_setting("ads_daily_quota", max(0, int(request.form.get("ads_daily_quota") or "10")))
                _set_setting("ads_points_per_view", max(0, int(request.form.get("ads_points_per_view") or "2")))
                _set_setting("ads_view_min_seconds", max(0, int(request.form.get("ads_view_min_seconds") or "10")))
                flash("Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§.")
            except ValueError:
                flash("ØªÚ©Ø§ÛŒÛ• Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨Ù†ÙˆÙˆØ³Û•.")
            return redirect(url_for("admin_ads_earn_settings"))
        data = {
            "ads_daily_quota": _get_setting("ads_daily_quota","10"),
            "ads_points_per_view": _get_setting("ads_points_per_view","2"),
            "ads_view_min_seconds": _get_setting("ads_view_min_seconds","10"),
        }
        try:
            return render_template("admin_ads_earn_settings.html", data=data)
        except Exception:
            return f"""<!doctype html><meta charset='utf-8'>
            <h3 style="font-family:system-ui">Ads Settings</h3>
            <form method="post">
              <div>Ú©Û†ØªØ§ÛŒÛŒ Ú•Û†Ú˜Ø§Ù†Û•: <input type="number" name="ads_daily_quota" value="{data['ads_daily_quota']}"></div>
              <div>Ù¾Û†ÛŒÙ†Øª/Ø³Û•ÛŒØ±Ú©Ø±Ø¯Ù†: <input type="number" name="ads_points_per_view" value="{data['ads_points_per_view']}"></div>
              <div>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•ÛŒ Ø³Û•ÛŒØ±Ú©Ø±Ø¯Ù†: <input type="number" name="ads_view_min_seconds" value="{data['ads_view_min_seconds']}"></div>
              <button>Save</button>
            </form>"""

print(f"[BOOT] Using file: {__file__}")
print(f"[BOOT] DB path: {_DB_PATH}")
# ===== END RESCUE PATCH =====
# Seed a demo game quickly (dev only)
@app.route("/dev/seed-game")
def dev_seed_game():
    con = db(); c = con.cursor()
    c.execute("INSERT INTO games(title, is_active, embed_html, points_override, min_seconds_override) VALUES (?,?,?,?,?)",
              ("Demo Game", 1, "", 5, 20))
    con.commit(); con.close()
    return "OK: demo game inserted"

# ===================== SAFETY PATCH (auto-generated) =====================
# This block prevents mis-routing of /admin/payouts and defines/aliases
# a few endpoints that frequently caused BuildError in templates.
from flask import request

def __ensure_endpoint(name, rule, view_func, methods=("GET",), endpoint=None):
    """Register a route only if the endpoint is not already present."""
    ep = endpoint or name
    try:
        if ep not in app.view_functions:
            app.add_url_rule(rule, endpoint=ep, view_func=view_func, methods=list(methods))
    except Exception:
        # Avoid hard-crashing in case the map has duplicates; best-effort only.
        pass

# --- Payouts view (minimal), used if your template exists ---
def __admin_payouts_view():
    try:
        # Try to render your real template; parameters are optional
        return render_template("admin_payouts.html")
    except Exception:
        # Fallback minimal HTML so the page always opens
        return "<!doctype html><meta charset='utf-8'><h2 style='font-family:sans-serif'>Payouts</h2><p>Template <code>templates/admin_payouts.html</code> not found.</p>"

# Guarantee the canonical /admin/payouts endpoint
__ensure_endpoint("admin_payouts", "/admin/payouts", __admin_payouts_view, methods=("GET","POST"))

# Guard: if anything tries to redirect /admin/payouts elsewhere, intercept it
@app.before_request
def __force_payouts_page():
    try:
        if request.path.rstrip("/") == "/admin/payouts":
            # Always serve the payouts view directly
            return app.view_functions.get("admin_payouts", __admin_payouts_view)()
    except Exception:
        # Never break the request flow
        return None

# Convenience short alias
__ensure_endpoint("admin_payout", "/admin/payout", lambda: redirect(url_for("admin_payouts")), methods=("GET",))

# --- Admin games: provide both toggle endpoints to avoid BuildError ---
def __toggle_game(game_id: int):
    con = db(); c = con.cursor()
    row = c.execute("SELECT is_active FROM games WHERE id=?", (game_id,)).fetchone()
    if not row:
        con.close(); abort(404)
    newv = 0 if int(row["is_active"] or 0) else 1
    c.execute("UPDATE games SET is_active=? WHERE id=?", (newv, game_id))
    con.commit(); con.close()
    flash("Ø­Ø§ÚµÛ•ØªÛŒ ÛŒØ§Ø±ÛŒ Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")
    return redirect(url_for("admin_games"))

def __admin_games_list():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT * FROM games ORDER BY id DESC").fetchall()
    con.close()
    try:
        return render_template("admin_games.html", rows=rows)
    except Exception:
        # Minimal fallback
        body = ["<h3 style='font-family:sans-serif'>Games</h3><ul>"]
        for r in rows:
            body.append(f"<li>#{r['id']} â€” {r['title']} â€” active={r['is_active']}</li>")
        body.append("</ul>")
        return "<!doctype html><meta charset='utf-8'>" + "".join(body)

__ensure_endpoint("admin_games", "/admin/games", __admin_games_list, methods=("GET",))
__ensure_endpoint("admin_game_toggle", "/admin/games/<int:game_id>/toggle", lambda game_id: __toggle_game(game_id), methods=("POST","GET"))
__ensure_endpoint("admin_games_toggle", "/admin/games/<int:game_id>/toggle2", lambda game_id: __toggle_game(game_id), methods=("POST","GET"))

# --- Surveys: safe delete & question actions (to stop BuildError) ---
def __admin_surveys_list():
    con = db(); c = con.cursor()
    rows = c.execute("SELECT * FROM surveys ORDER BY id DESC").fetchall()
    con.close()
    try:
        return render_template("admin_surveys.html", rows=rows)
    except Exception:
        items = "".join([f"<li>#{r['id']} â€” {r['title']}</li>" for r in rows])
        return f"<!doctype html><meta charset='utf-8'><h3>Surveys</h3><ul>{items}</ul>"

__ensure_endpoint("admin_surveys", "/admin/surveys", __admin_surveys_list, methods=("GET",))

def __delete_survey(survey_id: int):
    con = db(); c = con.cursor()
    # Cascade delete answers and questions via FK if set; otherwise manual
    try:
        c.execute("DELETE FROM surveys WHERE id=?", (survey_id,))
        con.commit()
    finally:
        con.close()
    flash("Ú•Ø§Ù¾Ø±Ø³ÛŒ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.")
    return redirect(url_for("admin_surveys"))

__ensure_endpoint("admin_survey_delete",
                  "/admin/surveys/<int:survey_id>/delete",
                  lambda survey_id: __delete_survey(survey_id),
                  methods=("POST","GET"))

# Question edit/move stubs to avoid template 404/BuildError
def __admin_survey_q_move(survey_id: int, q_id: int, direction: str):
    con = db(); c = con.cursor()
    q = c.execute("SELECT id,position FROM survey_questions WHERE id=? AND survey_id=?", (q_id, survey_id)).fetchone()
    if not q:
        con.close(); abort(404)
    pos = int(q["position"] or 0)
    new_pos = pos - 1 if direction == "up" else pos + 1
    # swap with neighbor
    neighbor = c.execute("SELECT id,position FROM survey_questions WHERE survey_id=? AND position=?",
                         (survey_id, new_pos)).fetchone()
    if neighbor:
        c.execute("UPDATE survey_questions SET position=? WHERE id=?", (pos, neighbor["id"]))
    c.execute("UPDATE survey_questions SET position=? WHERE id=?", (new_pos, q_id))
    con.commit(); con.close()
    return redirect(url_for("admin_survey_questions", survey_id=survey_id))

def __admin_survey_q_edit(survey_id: int, q_id: int):
    con = db(); c = con.cursor()
    q = c.execute("SELECT * FROM survey_questions WHERE id=? AND survey_id=?", (q_id, survey_id)).fetchone()
    if request.method == "POST":
        q_text = (request.form.get("q_text") or "").strip()
        q_type = (request.form.get("q_type") or "").strip()
        req    = 1 if request.form.get("required") else 0
        options= (request.form.get("options") or "").strip()
        show_if= (request.form.get("show_if_json") or "").strip()
        c.execute("""UPDATE survey_questions SET q_text=?, q_type=?, required=?,
                     options_json=?, show_if_json=? WHERE id=? AND survey_id=?""",
                  (q_text, q_type, req, options or None, show_if or None, q_id, survey_id))
        con.commit(); con.close()
        flash("Ù¾Ø±Ø³ÛŒØ§Ø± Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•.")
        return redirect(url_for("admin_survey_questions", survey_id=survey_id))
    con.close()
    # Minimal edit form
    return f"""<!doctype html><meta charset='utf-8'>
    <h3 style='font-family:sans-serif'>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ Ù¾Ø±Ø³ÛŒØ§Ø± #{q_id}</h3>
    <form method="post" style="max-width:720px">
      <label>Ø¯Û•Ù‚ÛŒ Ù¾Ø±Ø³ÛŒØ§Ø±</label><input name="q_text" value="{(q['q_text'] if q else '')}"><br>
      <label>Ø¬Û†Ø±</label><input name="q_type" value="{(q['q_type'] if q else '')}"><br>
      <label>Ù„Ø§Ø²Ù…Û•ØŸ</label><input type="checkbox" name="required" {"checked" if q and q['required'] else ""}><br>
      <label>Ø¦Û†Ù¾Ø´Ù†Û•Ú©Ø§Ù†</label><textarea name="options">{(q['options_json'] or '') if q else ''}</textarea><br>
      <label>Show If (JSON)</label><textarea name="show_if_json">{(q['show_if_json'] or '') if q else ''}</textarea><br>
      <button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button>
    </form>"""

__ensure_endpoint("admin_survey_q_move",
                  "/admin/surveys/<int:survey_id>/questions/<int:q_id>/move/<string:direction>",
                  lambda survey_id, q_id, direction: __admin_survey_q_move(survey_id, q_id, direction),
                  methods=("POST","GET"))

__ensure_endpoint("admin_survey_q_edit",
                  "/admin/surveys/<int:survey_id>/questions/<int:q_id>/edit",
                  lambda survey_id, q_id: __admin_survey_q_edit(survey_id, q_id),
                  methods=("GET","POST"))

__ensure_endpoint("admin_survey_q_delete",
                  "/admin/surveys/<int:survey_id>/questions/<int:q_id>/delete",
                  lambda survey_id, q_id: __delete_survey(survey_id),  # fallback; replace with real q-delete if you have one
                  methods=("POST","GET"))

# --- Aliases used in base.html menu to prevent BuildError ---
def __admin_dashboard():
    try:
        return render_template("admin_dashboard.html")
    except Exception:
        return "<!doctype html><meta charset='utf-8'><h3 style='font-family:sans-serif'>Dashboard</h3>"

def __admin_pages():
    # If you have a fancy editor template, it will render. Otherwise fallback.
    try:
        return render_template("admin_pages.html")
    except Exception:
        return "<!doctype html><meta charset='utf-8'><h3 style='font-family:sans-serif'>Pages</h3>"

def __admin_profile_options():
    try:
        return render_template("admin_profile_options.html")
    except Exception:
        return "<!doctype html><meta charset='utf-8'><h3 style='font-family:sans-serif'>Profile Options</h3>"

__ensure_endpoint("admin_dashboard", "/admin", __admin_dashboard, methods=("GET",))
__ensure_endpoint("admin_pages", "/admin/pages", __admin_pages, methods=("GET","POST"))
__ensure_endpoint("admin_profile_options", "/admin/profile/options", __admin_profile_options, methods=("GET","POST"))
# ===================== /SAFETY PATCH =====================
# ===== [PAGES VIEWER FIX] define public page_view by slug =====
from flask import abort, render_template, redirect, url_for

# /p/<slug>  â†’ endpoint=page_view   (Ø¦Û•Ù…Û•ÛŒ url_for('page_view', slug=...) Ø¨Û•Ú©Ø§Ø±Ø¯ÛÙ†)
if "page_view" not in app.view_functions:
    def page_view(slug: str):
        con = db(); c = con.cursor()
        row = c.execute("SELECT * FROM pages WHERE slug=?", (slug,)).fetchone()
        con.close()
        if not row:
            abort(404)

        # title & content coalesce
        def _get(d, k, default=""):
            try:
                return d[k] if (hasattr(d, "keys") and k in d.keys()) else default
            except Exception:
                return default

        title = _get(row, "title", _get(row, "slug", slug))
        content_html = _get(row, "content_html", _get(row, "content", ""))

        # Try template; fallback HTML Ø§Ú¯Ø± template Ù†ÛŒÛ•
        try:
            return render_template("page_view.html", page=row, content_html=content_html)
        except Exception:
            return (
                "<!doctype html><meta charset='utf-8'>"
                f"<h2 style='font-family:sans-serif'>{title}</h2>"
                f"<div>{content_html}</div>"
            )

    app.add_url_rule("/p/<string:slug>", endpoint="page_view", view_func=page_view, methods=["GET"])

# alias: /pages/<slug> â†’ /p/<slug>
if "page_view_alias" not in app.view_functions:
    app.add_url_rule(
        "/pages/<string:slug>",
        endpoint="page_view_alias",
        view_func=lambda slug: redirect(url_for("page_view", slug=slug)),
        methods=["GET"],
    )
# ===== [/PAGES VIEWER FIX] =====


# ==== BEGIN AUTO-PATCH (Games Admin) ====
# Make slashes flexible
try:
    app.url_map.strict_slashes = False
except Exception:
    pass

# Common imports (safe if duplicates)
try:
    from functools import wraps
    from jinja2 import TemplateNotFound as _JinjaTemplateNotFound
except Exception:
    class _JinjaTemplateNotFound(Exception): pass

def _games_inline_new_form():
    return (
        "<!doctype html><meta charset='utf-8'><title>+ ÛŒØ§Ø±ÛŒÛŒ Ù†ÙˆÛ</title>"
        "<h2 style='font-family:Tahoma,Arial'>+ ÛŒØ§Ø±ÛŒÛŒ Ù†ÙˆÛ</h2>"
        "<form method='post' action='/admin/games' style='max-width:700px;padding:12px;border:1px solid #ddd;border-radius:10px'>"
        "<label>Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†<br><input name='title' required style='width:100%'></label>"
        "<div style='margin-top:10px'><button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button> <a href='/admin/games'>Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>"
        "</form>"
    )

def _games_fetch(game_id):
    # Return dict even if DB/row missing
    try:
        con = db(); c = con.cursor()
        row = c.execute("SELECT id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active FROM games WHERE id=?", (game_id,)).fetchone()
        con.close()
        if not row:
            return dict(id=game_id, title="", thumbnail_url="", play_url="", embed_html="", points_override=0, min_seconds_override=0, is_active=1)
        try:
            return dict(row)
        except Exception:
            cols = ["id","title","thumbnail_url","play_url","embed_html","points_override","min_seconds_override","is_active"]
            return {k: row[i] if i < len(row) else None for i,k in enumerate(cols)}
    except Exception:
        return dict(id=game_id, title="", thumbnail_url="", play_url="", embed_html="", points_override=0, min_seconds_override=0, is_active=1)

def _to_int(v, default=0):
    try: return int(v)
    except Exception: return default

def _games_save(game_id, form):
    title = (form.get("title") or "").strip()
    thumbnail_url = (form.get("thumbnail_url") or "").strip()
    play_url = (form.get("play_url") or "").strip()
    embed_html = (form.get("embed_html") or "").strip()
    points_override = _to_int(form.get("points_override") or 0)
    min_seconds_override = _to_int(form.get("min_seconds_override") or 0)
    is_active = 1 if (form.get("is_active") in ("1","on","true","True")) else 0
    try:
        con = db(); c = con.cursor()
        exists = c.execute("SELECT 1 FROM games WHERE id=?", (game_id,)).fetchone()
        if exists:
            c.execute("""
                UPDATE games
                   SET title=?,
                       thumbnail_url=?,
                       play_url=?,
                       embed_html=?,
                       points_override=?,
                       min_seconds_override=?,
                       is_active=?
                 WHERE id=?
            """, (title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active, game_id))
        else:
            c.execute("""
                INSERT INTO games (id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active)
                VALUES (?,?,?,?,?,?,?,?)
            """, (game_id, title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active))
        con.commit(); con.close()
        return True
    except Exception:
        try: con.rollback(); con.close()
        except Exception: pass
        return False

# Guarantee /admin/games/new exists and never 404s
try:
    vf = app.view_functions
except Exception:
    vf = {}

if isinstance(vf, dict) and 'admin_games_new' not in vf:
    @app.route('/admin/games/new', methods=['GET'], endpoint='admin_games_new')
    @admin_required
    def __admin_games_new():
        try:
            return render_template('admin/games/new.html')
        except _JinjaTemplateNotFound:
            return _games_inline_new_form()
        except Exception:
            return _games_inline_new_form()

# Force /admin/games/<id>/edit to always render a full form on GET, and save on POST
# [REMOVED] duplicate decorator for /admin/games/<int:game_id>/edit
@admin_required
def __admin_games_edit_forced(game_id: int):
    if request.method == 'POST':
        if _games_save(game_id, request.form):
            try: flash("Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.", "success")
            except Exception: pass
            return redirect(url_for('admin_games'))
        try: flash("Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¨Ú©Ø±ÛØª.", "error")
        except Exception: pass
    game = _games_fetch(game_id)
    try:
        return render_template('admin/games/edit.html', game=game)
    except Exception:
        # inline fallback form
        active_checked = "checked" if game.get("is_active") else ""
        return (
            "<!doctype html><meta charset='utf-8'>"
            f"<h2>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ ÛŒØ§Ø±ÛŒ #{game_id}</h2>"
            "<form method='post' style='max-width:700px;padding:12px;border:1px solid #ddd;border-radius:10px'>"
            f"<label>Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†<br><input name='title' value='{game.get('title','')}' required style='width:100%'></label>"
            f"<label>Thumbnail URL<br><input name='thumbnail_url' value='{game.get('thumbnail_url','')}' style='width:100%'></label>"
            f"<label>Play URL<br><input name='play_url' value='{game.get('play_url','')}' style='width:100%'></label>"
            f"<label>Embed HTML<br><textarea name='embed_html' rows='5' style='width:100%'>{game.get('embed_html','')}</textarea></label>"
            f"<label>Ù†Ù…Ø±Û•ÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ<br><input type='number' name='points_override' value='{game.get('points_override',0)}'></label>"
            f"<label>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•<br><input type='number' name='min_seconds_override' value='{game.get('min_seconds_override',0)}'></label>"
            f"<label style='display:flex;align-items:center;gap:.5rem'><input type='checkbox' name='is_active' value='1' {active_checked}> Ú†Ø§Ù„Ø§Ú©</label>"
            "<div style='margin-top:10px'><button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button> <a href='/admin/games'>Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>"
            "</form>"
        )

# Aliases and catch-all to avoid 404s
@app.route('/admin/games/<int:game_id>/config', methods=['GET','POST'])
@admin_required
def __admin_games_config_alias(game_id: int):
    return redirect(url_for('admin_games_edit', game_id=game_id))

@app.route('/admin/games/<int:game_id>/<path:subpath>', methods=['GET','POST'])
@admin_required
def __admin_games_catch_all(game_id: int, subpath: str):
    sp = (subpath or '').strip('/').lower()
    if sp in {'config','configuration','settings','options','setup','manage','management'}:
        return redirect(url_for('admin_games_edit', game_id=game_id))
    if sp == 'edit':
        return redirect(url_for('admin_games_edit', game_id=game_id))
    if sp == 'play':
        return redirect(f"/games/{int(game_id)}/play")
    # help page
    return (
        "<!doctype html><meta charset='utf-8'>"
        f"<h3>Ú•ÛÚ¯Ø§ÛŒ Ù†Û•Ù†Ø§Ø³Ø±Ø§Ùˆ: <code>{subpath}</code></h3>"
        f"<ul><li><a href='/admin/games/{game_id}/edit'>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ</a></li>"
        f"<li><a href='/games/{game_id}/play' target='_blank'>Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</a></li>"
        f"<li><a href='/admin/games'>âŸµ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></li></ul>"
    )

# Dev helper: list routes
if '__routes' not in app.view_functions:
    @app.route("/__routes")
    def __routes():
        try:
            rows = []
            with app.app_context():
                for rule in app.url_map.iter_rules():
                    methods = ",".join(sorted(rule.methods - {"HEAD","OPTIONS"}))
                    rows.append(f"<tr><td>{rule.rule}</td><td>{rule.endpoint}</td><td>{methods}</td></tr>")
            table = "<table border='1' cellpadding='6'><tr><th>Rule</th><th>Endpoint</th><th>Methods</th></tr>" + "".join(rows) + "</table>"
            return "<h3>Registered Routes</h3>" + table
        except Exception as e:
            return f"<pre>{e}</pre>", 500
# ==== END AUTO-PATCH (Games Admin) ====

# === SAFE REBIND for /admin/games/<id>/edit (no duplicate endpoints) ===
try:
    from functools import wraps
except Exception:
    pass

def __forced_admin_games_edit(game_id: int):
    # --- Ù‡Û•Ù…Ø§Ù† Ù„Ø§Ø¬ÛŒÚ©Û•Ú©Û•Øª Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•/Ø¨ÛØª (Ú©Û• Ù„Û• ÙˆÛ•Ø´Ø§Ù†ÛŒ Ù¾ÛØ´ÙˆÙˆ Ø¨ÙˆÙˆ) ---
    # GET -> render template (fallback inline if needed)
    # POST -> save (UPDATE/INSERT) then redirect to admin_games
    game = _games_fetch(game_id)
    if request.method == "POST":
        if _games_save(game_id, request.form):
            try: flash("Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.", "success")
            except Exception: pass
            return redirect(url_for("admin_games"))
        try: flash("Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ø¨Ú©Ø±ÛØª.", "error")
        except Exception: pass
    try:
        return render_template("admin/games/edit.html", game=game)
    except Exception:
        active_checked = "checked" if game.get("is_active") else ""
        return (
            "<!doctype html><meta charset='utf-8'>"
            f"<h2>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ ÛŒØ§Ø±ÛŒ #{game_id}</h2>"
            "<form method='post' style='max-width:700px;padding:12px;border:1px solid #ddd;border-radius:10px'>"
            f"<label>Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†<br><input name='title' value='{game.get('title','')}' required style='width:100%'></label>"
            f"<label>Thumbnail URL<br><input name='thumbnail_url' value='{game.get('thumbnail_url','')}' style='width:100%'></label>"
            f"<label>Play URL<br><input name='play_url' value='{game.get('play_url','')}' style='width:100%'></label>"
            f"<label>Embed HTML<br><textarea name='embed_html' rows='5' style='width:100%'>{game.get('embed_html','')}</textarea></label>"
            f"<label>Ù†Ù…Ø±Û•ÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ<br><input type='number' name='points_override' value='{game.get('points_override',0)}'></label>"
            f"<label>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•<br><input type='number' name='min_seconds_override' value='{game.get('min_seconds_override',0)}'></label>"
            f"<label style='display:flex;align-items:center;gap:.5rem'><input type='checkbox' name='is_active' value='1' {active_checked}> Ú†Ø§Ù„Ø§Ú©</label>"
            "<div style='margin-top:10px'><button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button> <a href='/admin/games'>Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>"
            "</form>"
        )

# â€” registration logic without duplicate â€”
try:
    if 'admin_games_edit' in app.view_functions:
        # endpoint already exists -> just replace the view function
        app.view_functions['admin_games_edit'] = admin_required(__forced_admin_games_edit)
    else:
        # endpoint missing -> add the rule now
        app.add_url_rule(
            '/admin/games/<int:game_id>/edit',
            endpoint='admin_games_edit',
            view_func=admin_required(__forced_admin_games_edit),
            methods=['GET','POST']
        )
except Exception as e:
    print("SAFE REBIND admin_games_edit failed:", e)
# === END SAFE REBIND ===



# === BEGIN: SINGLE CLEAN BIND of admin_games_edit ===
def __ag_db():
    try:
        return db()
    except Exception:
        BASE_DIR = os.path.dirname(os.path.abspath(__file__))
        con = sqlite3.connect(os.path.join(BASE_DIR, 'survey.db'), timeout=30, check_same_thread=False)
        con.row_factory = sqlite3.Row
        return con

def __ag_get_game(game_id):
    con = __ag_db(); c = con.cursor()
    try:
        row = c.execute('SELECT id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active FROM games WHERE id=?', (game_id,)).fetchone()
    except Exception:
        row = c.execute('SELECT id,title,embed_url as play_url,is_active FROM games WHERE id=?', (game_id,)).fetchone()
    con.close()
    if not row:
        return {'id': game_id, 'title': '', 'thumbnail_url': '', 'play_url': '', 'embed_html': '', 'points_override': 0, 'min_seconds_override': 0, 'is_active': 1}
    try:
        return dict(row)
    except Exception:
        cols = ['id','title','thumbnail_url','play_url','embed_html','points_override','min_seconds_override','is_active']
        return {k: (row[i] if i < len(row) else None) for i,k in enumerate(cols)}

def __ag_save_game(game_id, form):
    def to_int(v, d=0):
        try: return int(v)
        except Exception: return d
    title = (form.get('title') or '').strip()
    thumbnail_url = (form.get('thumbnail_url') or '').strip()
    play_url = (form.get('play_url') or '').strip()
    embed_html = (form.get('embed_html') or '').strip()
    points_override = to_int(form.get('points_override') or 0)
    min_seconds_override = to_int(form.get('min_seconds_override') or 0)
    is_active = 1 if (form.get('is_active') in ('1','on','true','True')) else 0
    con = __ag_db(); c = con.cursor()
    exists = c.execute('SELECT 1 FROM games WHERE id=?', (game_id,)).fetchone()
    if exists:
        try:
            c.execute('UPDATE games SET title=?, thumbnail_url=?, play_url=?, embed_html=?, points_override=?, min_seconds_override=?, is_active=? WHERE id=?',
                      (title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active, game_id))
        except Exception:
            c.execute('UPDATE games SET title=?, embed_url=?, is_active=? WHERE id=?',
                      (title, play_url, is_active, game_id))
    else:
        try:
            c.execute('INSERT INTO games (id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active) VALUES (?,?,?,?,?,?,?,?)',
                      (game_id, title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active))
        except Exception:
            c.execute('INSERT INTO games (id,title,embed_url,is_active) VALUES (?,?,?,?)',
                      (game_id, title, play_url, is_active))
    con.commit(); con.close()

# safety: drop any existing mapping at runtime (in case a leftover bind happened earlier in import order)
try:
    app.view_functions.pop('admin_games_edit', None)
except Exception:
    pass

# [REMOVED duplicate decorator /admin/games/<int:game_id>/edit]
@admin_required
def admin_games_edit_legacy_removed(game_id):
    if request.method == 'POST':
        __ag_save_game(game_id, request.form)
        try:
            flash('Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.', 'success')
        except Exception:
            pass
        return redirect(url_for('admin_games'))
    game = __ag_get_game(game_id)
    try:
        return render_template('admin/games/edit.html', game=game)
    except Exception:
        active = 'checked' if game.get('is_active') else ''
        return (
            "<!doctype html><meta charset='utf-8'>"
            f"<h2>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ ÛŒØ§Ø±ÛŒ #{game_id}</h2>"
            "<form method='post' style='max-width:700px;padding:12px;border:1px solid #ddd;border-radius:10px'>"
            f"<label>Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†<br><input name='title' value='{game.get('title','')}' required style='width:100%'></label>"
            f"<label>Thumbnail URL<br><input name='thumbnail_url' value='{game.get('thumbnail_url','')}' style='width:100%'></label>"
            f"<label>Play URL<br><input name='play_url' value='{game.get('play_url','')}' style='width:100%'></label>"
            f"<label>Embed HTML<br><textarea name='embed_html' rows='5' style='width:100%'>{game.get('embed_html','')}</textarea></label>"
            f"<label>Ù†Ù…Ø±Û•ÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ<br><input type='number' name='points_override' value='{game.get('points_override',0)}'></label>"
            f"<label>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•<br><input type='number' name='min_seconds_override' value='{game.get('min_seconds_override',0)}'></label>"
            f"<label style='display:flex;align-items:center;gap:.5rem'><input type='checkbox' name='is_active' value='1' {active}> Ú†Ø§Ù„Ø§Ú©</label>"
            "<div style='margin-top:10px'><button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button> <a href='/admin/games'>Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>"
            "</form>"
        )

@app.route('/admin/games/<int:game_id>/config', methods=['GET','POST'])
@admin_required
def admin_games_config(game_id):
    return redirect(url_for('admin_games_edit', game_id=game_id))

@app.route('/admin/games/<int:game_id>/<path:subpath>', methods=['GET','POST'])
@admin_required
def admin_games_catch_all(game_id, subpath):
    sp = (subpath or '').strip('/').lower()
    if sp in {'config','configuration','settings','options','setup','manage','management','edit'}:
        return redirect(url_for('admin_games_edit', game_id=game_id))
    if sp == 'play':
        return redirect(f'/games/{int(game_id)}/play')
    return (
        "<!doctype html><meta charset='utf-8'>"
        f"<h3>Ú•ÛÚ¯Ø§ÛŒ Ù†Û•Ù†Ø§Ø³Ø±Ø§Ùˆ: <code>{subpath}</code></h3>"
        f"<ul><li><a href='/admin/games/{game_id}/edit'>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ</a></li>"
        f"<li><a href='/games/{game_id}/play' target='_blank'>Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</a></li>"
        f"<li><a href='/admin/games'>âŸµ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></li></ul>"
    )
# === END CLEAN BIND ===

# === Portal routes ===
@app.route('/portal', methods=['GET','POST'], endpoint='portal_index')
def portal_index():
    if request.method == 'POST':
        session['username'] = (request.form.get('username') or '').strip() or None
        return redirect(url_for('portal_index'))
    con = sqlite3.connect(os.path.join(os.path.dirname(os.path.abspath(__file__)), 'survey.db'), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row; c = con.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS games (id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, embed_url TEXT, is_active INTEGER DEFAULT 1)')
    rows = c.execute('SELECT id,title,COALESCE(embed_url,"") as embed_url, COALESCE(is_active,1) as is_active FROM games ORDER BY id DESC').fetchall()
    con.close()
    ppm = 10; minsec = 30
    return render_template('portal/index.html', games=[dict(r) for r in rows], wallet=__portal_wallet(), points_per_minute=ppm, min_seconds=minsec)
def __portal_wallet():
    user = session.get('username')
    if not user: return 0
    con = sqlite3.connect(os.path.join(os.path.dirname(os.path.abspath(__file__)), 'survey.db'), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row; c = con.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, wallet_points INTEGER DEFAULT 0, created_at TEXT)')
    con.commit()
    row = c.execute('SELECT wallet_points FROM users WHERE username=?', (user,)).fetchone()
    if not row:
        c.execute('INSERT INTO users(username, wallet_points, created_at) VALUES (?,?,datetime("now"))', (user, 0))
        con.commit(); con.close(); return 0
    con.close()
    try: return row['wallet_points']
    except Exception: return row[0] if row else 0
@app.route('/api/wallet', methods=['GET'])
def api_wallet():
    return jsonify(ok=True, wallet=__portal_wallet())
@app.route('/api/earn', methods=['POST'])
def api_earn():
    data = request.get_json(silent=True) or {}
    seconds = int(data.get('seconds') or 0)
    if seconds <= 0: return jsonify(ok=False, error='seconds<=0'), 400
    user = session.get('username')
    if not user: return jsonify(ok=False, error='no user in session'), 400
    add = int(10 * (seconds/60.0))
    con = sqlite3.connect(os.path.join(os.path.dirname(os.path.abspath(__file__)), 'survey.db'), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row; c = con.cursor()
    c.execute('UPDATE users SET wallet_points = COALESCE(wallet_points,0) + ? WHERE username=?', (add, user))
    if c.rowcount == 0:
        c.execute('INSERT INTO users(username, wallet_points, created_at) VALUES (?,?,datetime("now"))', (user, add))
    con.commit(); con.close()
    return jsonify(ok=True, wallet=__portal_wallet())
@app.route('/portal/game/<int:game_id>', methods=['GET'], endpoint='portal_game')
def portal_game(game_id):
    room = request.args.get('room','public')
    con = sqlite3.connect(os.path.join(os.path.dirname(os.path.abspath(__file__)), 'survey.db'), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row; c = con.cursor()
    row = c.execute('SELECT id,title,play_url,embed_html,embed_url FROM games WHERE id=?', (game_id,)).fetchone()
    con.close()
    if not row: return redirect(url_for('portal_index'))
    game = dict(row) if hasattr(row, 'keys') else {}
    title = game.get('title') or f'Game #{game_id}'
    src = (game.get('play_url') or game.get('embed_url') or '').strip() or 'about:blank'
    return render_template('portal/play.html', game={'id':game_id,'title':title,'embed_url':src}, room=room, points_per_minute=10, min_seconds=30)
# === /Portal routes ===

# === BEGIN: SINGLE CLEAN BIND of admin_games_edit ===
def __ag_db():
    import sqlite3, os
    BASE = os.path.dirname(os.path.abspath(__file__))
    con = sqlite3.connect(os.path.join(BASE, 'survey.db'), timeout=30, check_same_thread=False)
    con.row_factory = sqlite3.Row
    return con

def __ag_get_game(game_id):
    con = __ag_db(); c = con.cursor()
    try:
        row = c.execute('SELECT id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active FROM games WHERE id=?', (game_id,)).fetchone()
    except Exception:
        row = c.execute('SELECT id,title,embed_url as play_url,is_active FROM games WHERE id=?', (game_id,)).fetchone()
    con.close()
    if not row:
        return {'id': game_id, 'title': '', 'thumbnail_url': '', 'play_url': '', 'embed_html': '', 'points_override': 0, 'min_seconds_override': 0, 'is_active': 1}
    try:
        return dict(row)
    except Exception:
        cols = ['id','title','thumbnail_url','play_url','embed_html','points_override','min_seconds_override','is_active']
        return {k: (row[i] if i < len(row) else None) for i,k in enumerate(cols)}

def __ag_save_game(game_id, form):
    def to_int(v, d=0):
        try: return int(v)
        except Exception: return d
    title = (form.get('title') or '').strip()
    thumbnail_url = (form.get('thumbnail_url') or '').strip()
    play_url = (form.get('play_url') or '').strip()
    embed_html = (form.get('embed_html') or '').strip()
    points_override = to_int(form.get('points_override') or 0)
    min_seconds_override = to_int(form.get('min_seconds_override') or 0)
    is_active = 1 if (form.get('is_active') in ('1','on','true','True')) else 0
    con = __ag_db(); c = con.cursor()
    exists = c.execute('SELECT 1 FROM games WHERE id=?', (game_id,)).fetchone()
    if exists:
        try:
            c.execute('UPDATE games SET title=?, thumbnail_url=?, play_url=?, embed_html=?, points_override=?, min_seconds_override=?, is_active=? WHERE id=?',
                      (title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active, game_id))
        except Exception:
            c.execute('UPDATE games SET title=?, embed_url=?, is_active=? WHERE id=?',
                      (title, play_url, is_active, game_id))
    else:
        try:
            c.execute('INSERT INTO games (id,title,thumbnail_url,play_url,embed_html,points_override,min_seconds_override,is_active) VALUES (?,?,?,?,?,?,?,?)',
                      (game_id, title, thumbnail_url, play_url, embed_html, points_override, min_seconds_override, is_active))
        except Exception:
            c.execute('INSERT INTO games (id,title,embed_url,is_active) VALUES (?,?,?,?)',
                      (game_id, title, play_url, is_active))
    con.commit(); con.close()

@app.route('/admin/games/<int:game_id>/edit', methods=['GET','POST'], endpoint='admin_games_edit')
@admin_required
def admin_games_edit(game_id):
    if request.method == 'POST':
        __ag_save_game(game_id, request.form)
        try: flash('Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†.', 'success')
        except Exception: pass
        return redirect(url_for('admin_games'))
    game = __ag_get_game(game_id)
    try:
        return render_template('admin/games/edit.html', game=game)
    except Exception:
        active = 'checked' if game.get('is_active') else ''
        return (
            "<!doctype html><meta charset='utf-8'>"
            f"<h2>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ ÛŒØ§Ø±ÛŒ #{game_id}</h2>"
            "<form method='post' style='max-width:700px;padding:12px;border:1px solid #ddd;border-radius:10px'>"
            f"<label>Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†<br><input name='title' value='{game.get('title','')}' required style='width:100%'></label>"
            f"<label>Thumbnail URL<br><input name='thumbnail_url' value='{game.get('thumbnail_url','')}' style='width:100%'></label>"
            f"<label>Play URL<br><input name='play_url' value='{game.get('play_url','')}' style='width:100%'></label>"
            f"<label>Embed HTML<br><textarea name='embed_html' rows='5' style='width:100%'>{game.get('embed_html','')}</textarea></label>"
            f"<label>Ù†Ù…Ø±Û•ÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ<br><input type='number' name='points_override' value='{game.get('points_override',0)}'></label>"
            f"<label>Ú©Û•Ù…ØªØ±ÛŒÙ† Ú†Ø±Ú©Û•<br><input type='number' name='min_seconds_override' value='{game.get('min_seconds_override',0)}'></label>"
            f"<label style='display:flex;align-items:center;gap:.5rem'><input type='checkbox' name='is_active' value='1' {active}> Ú†Ø§Ù„Ø§Ú©</label>"
            "<div style='margin-top:10px'><button>Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª</button> <a href='/admin/games'>Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></div>"
            "</form>"
        )

@app.route('/admin/games/<int:game_id>/config', methods=['GET','POST'])
@admin_required
def admin_games_config(game_id):
    return redirect(url_for('admin_games_edit', game_id=game_id))

@app.route('/admin/games/<int:game_id>/<path:subpath>', methods=['GET','POST'])
@admin_required
def admin_games_catch_all(game_id, subpath):
    sp = (subpath or '').strip('/').lower()
    if sp in {'config','configuration','settings','options','setup','manage','management','edit'}:
        return redirect(url_for('admin_games_edit', game_id=game_id))
    if sp == 'play':
        return redirect(f'/games/{int(game_id)}/play')
    return (
        "<!doctype html><meta charset='utf-8'>"
        f"<h3>Ú•ÛÚ¯Ø§ÛŒ Ù†Û•Ù†Ø§Ø³Ø±Ø§Ùˆ: <code>{subpath}</code></h3>"
        f"<ul><li><a href='/admin/games/{game_id}/edit'>Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ</a></li>"
        f"<li><a href='/games/{game_id}/play' target='_blank'>Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</a></li>"
        f"<li><a href='/admin/games'>âŸµ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</a></li></ul>"
    )
# === END SINGLE BIND ===



if __name__ == "__main__":


    __portal_init_db()

    import os
    host = os.getenv("HOST", "127.0.0.1")   # Ø¯Û•ØªÙˆØ§Ù†ÛŒØª "0.0.0.0" Ø¨Ú©Û•ÛŒØªÛ•ÙˆÛ•
    port = int(os.getenv("PORT", "5000"))   # Ø¯Û•ØªÙˆØ§Ù†ÛŒØª 5001 ÛŒØ§Ù† 8000 ØªØ§Ù‚ÛŒ Ø¨Ú©Û•ÛŒØª
    print(f"[BOOT] DB: {DB_PATH}")
    app.run(host=host, port=port, debug=True)


def __portal_init_db():
    pass

app.secret_key = app.config.get('SECRET_KEY', 'dev-portal-secret')
