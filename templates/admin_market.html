{% extends "base.html" %}
{% block title %}بەڕێوەبردنی بازار{% endblock %}
{% block content %}
<h2>بەڕێوەبردنی بازار</h2>
<form method="post" class="card" enctype="multipart/form-data">
  <input type="hidden" name="action" value="add">
  <div class="grid grid-3">
    <div class="row"><label>ناوی بەرهەم</label><input type="text" name="name" required></div>
    <div class="row"><label>نرخ (پۆینت)</label><input type="number" name="price_points" min="1" required></div>
    <div class="row"><label>کۆی بەردەست</label><input type="number" name="stock" min="0" value="0"></div>
    <div class="row"><label>جۆر</label><input type="text" name="item_type"></div>
    <div class="row"><label>دۆخ</label><input type="text" name="status"></div>
    <div class="row"><label>مۆدێل</label><input type="text" name="model"></div>
    <div class="row"><label>پەسنی کورت</label><textarea name="short_desc" rows="2"></textarea></div>
    <div class="row"><label>لینکی وێنە</label><input type="url" name="image_url" placeholder="https://..."></div>
    <div class="row"><label>وێنە</label><input type="file" name="image" accept=".jpg,.jpeg,.png,.webp"></div>
    <div class="row"><label>meta_json (ڕەها)</label><input type="text" name="meta_json" placeholder='{}'></div>
  </div>
  <button class="btn btn-primary" type="submit">زیادکردن</button>
</form>

<hr>
<h3>لیستی بەرهەمەکان</h3>
<table class="table">
  <thead>
    <tr><th>ID</th><th>ناو</th><th>نرخ</th><th>ستۆک</th><th>جۆر</th><th>دۆخ</th><th>مۆدێل</th><th>پەسن</th><th>وێنە</th><th colspan="2">کردار</th></tr>
  </thead>
  <tbody>
  {% for it in items %}
    {% set _m = (it.meta_json|fromjson) %}
    <tr>
      <td>{{ it.id }}</td>
      <td>{{ it.name }}</td>
      <td>{{ it.price_points }}</td>
      <td>{{ it.stock }}</td>
      <td>{{ _m.get('type','') }}</td>
      <td>{{ _m.get('status','') }}</td>
      <td>{{ _m.get('model','') }}</td>
      <td>{{ _m.get('short_desc','') }}</td>
      <td>{% if _m.get('image') %}<a href="{{ _m.get('image') }}" target="_blank">لینک</a>{% endif %}</td>
      <td><a class="btn btn-outline" href="/admin/market/{{ it.id }}/edit">دەستکاری</a></td>
      <td>
        <form method="post" action="/admin/market/{{ it.id }}/delete" onsubmit="return confirm('دڵنیایت لە سڕینەوە؟')">
          <button class="btn btn-danger" type="submit">سڕینەوە</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<hr>
<h4>ئۆردەرەكان</h4>
<!-- Filters -->
<form method="get" class="card" style="margin:10px 0;">
  <div class="grid grid-4">
    <div class="row"><label>گەڕان</label><input type="text" name="q" value="{{ request.args.get('q','') }}"></div>
    <div class="row"><label>دۆخ</label>
      <select name="status">
        <option value="">--هەموو--</option>
        {% for s in ["pending","processing","shipped","delivered","cancelled"] %}
          <option value="{{ s }}" {% if request.args.get("status")==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="row"><label>ژمارەی تەلەفون</label><input type="text" name="phone" value="{{ request.args.get('phone','') }}"></div>
    <div class="row" style="align-self:end"><button class="btn" type="submit">فلتەر</button></div>
  </div>
</form>

<table class="table" border="1" cellpadding="8" cellspacing="0" width="100%">
  <thead>
    <tr>
      <th>ID</th><th>ناوى كڕيار</th><th>تەلەفون</th><th>ناونیشان</th><th>دۆخ</th><th>تێبینی</th>
      <th>Notify</th><th>Logs</th>
    </tr>
  </thead>
  <tbody>
  {% for o in orders %}
    {# Robust access (tuple/dict/Row) #}
    {% set oid   = (o.id if o.id is defined else (o['id'] if o['id'] is defined else (o[0] if o is sequence else o))) %}
    {% set name  = (o.buyer_name if o.buyer_name is defined else (o['buyer_name'] if o['buyer_name'] is defined else (o[2] if o is sequence else ''))) %}
    {% set phone = (o.phone if o.phone is defined else (o['phone'] if o['phone'] is defined else (o[4] if o is sequence else ''))) %}
    {% set addr  = (o.address if o.address is defined else (o['address'] if o['address'] is defined else (o[3] if o is sequence else ''))) %}
    {% set status= (o.status if o.status is defined else (o['status'] if o['status'] is defined else (o[6] if o is sequence else ''))) %}
    {% set notes = (o.notes if o.notes is defined else (o['notes'] if o['notes'] is defined else (o[5] if o is sequence else ''))) %}

    {# Fallback path for notify to avoid BuildError #}
    {% set notify_action = '/admin/market/order/' ~ oid ~ '/notify' %}

    <tr>
      <td>{{ oid }}</td>
      <td>{{ name }}</td>
      <td>{{ phone }}</td>
      <td>{{ addr }}</td>
      <td>
        <form method="post" action="{{ url_for('admin_market_order_update', order_id=oid) }}">
          <select name="status">
            {% for s in ["pending","processing","shipped","delivered","cancelled"] %}
              <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit">گۆڕین</button>
        </form>
      </td>
      <td>{{ notes }}</td>

      <!-- Notify buttons (use direct path to avoid BuildError) -->
      <td>
        <form method="post" action="{{ notify_action }}" style="display:inline-block">
          <button class="btn" type="submit">Notify</button>
        </form>
        <form method="post" action="{{ notify_action }}" style="display:inline-block">
          <input type="hidden" name="channel" value="sms"><button class="btn" type="submit">SMS</button>
        </form>
        <form method="post" action="{{ notify_action }}" style="display:inline-block">
          <input type="hidden" name="channel" value="email"><button class="btn" type="submit">Email</button>
        </form>
        <form method="post" action="{{ notify_action }}" style="display:inline-block">
          <input type="hidden" name="channel" value="whatsapp"><button class="btn" type="submit">WhatsApp</button>
        </form>
        <form method="post" action="{{ notify_action }}" style="display:inline-block">
          <input type="hidden" name="channel" value="telegram"><button class="btn" type="submit">Telegram</button>
        </form>
<form method="post" action="{{ url_for('admin_market_order_notify', order_id=oid) }}" style="display:inline-block">
  <input type="hidden" name="channel" value="email">
  <button class="btn">Email</button>
</form>

<form method="post" action="{{ url_for('admin_market_order_notify', order_id=oid) }}" style="display:inline-block">
  <input type="hidden" name="channel" value="sms">
  <button class="btn">SMS</button>
</form>

<form method="post" action="{{ url_for('admin_market_order_notify', order_id=oid) }}" style="display:inline-block">
  <input type="hidden" name="channel" value="notify">
  <button class="btn">Notify</button>
</form>
      </td>

      <!-- Logs -->
      <td>
        {% set logs = logs_by_order.get(oid) if logs_by_order else [] %}
        {% if logs %}
          <details>
            <summary>Logs ({{ logs|length }})</summary>
            <ul>
              {% for lg in logs %}
                {% set ch = lg.channel if lg.channel is defined else (lg['channel'] if lg['channel'] is defined else (lg[0] if lg is sequence else '')) %}
                {% set ok = lg.success if lg.success is defined else (lg['success'] if lg['success'] is defined else (lg[1] if lg is sequence else 0)) %}
                {% set msg = lg.message if lg.message is defined else (lg['message'] if lg['message'] is defined else (lg[2] if lg is sequence else '')) %}
                {% set ts  = lg.created_at if lg.created_at is defined else (lg['created_at'] if lg['created_at'] is defined else (lg[3] if lg is sequence else '')) %}
                <li>[{{ ts }}] <strong>{{ ch }}</strong> — {% if ok %}OK{% else %}FAIL{% endif %} — {{ msg }}</li>
              {% endfor %}
            </ul>
          </details>
        {% else %}
          <em>هیچ لاگێک نییە</em>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
