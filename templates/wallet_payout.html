{% extends "base.html" %}
{% block title %}Wallet — Cash Out{% endblock %}
{% block content %}
<h2>کاش‌ئاووت (پەرەدان)</h2>

<div class="card" style="max-width:960px">
  <div class="grid grid-3">
    <div class="row"><strong>باڵانس:</strong> {{ balance }} pts</div>
    <div class="row"><strong>نرخ:</strong> 1 pt = {{ money_per_point }} IQD</div>
    <div class="row"><strong>کەمترین پەرەدان:</strong> {{ min_payout_points }} pts &nbsp; | &nbsp; فی: {{ payout_fee_points }} pts</div>
  </div>
</div>

<div class="grid grid-2" style="margin-top:12px">
  <div class="card">
    <h3 style="margin-top:0">داوا کردنی پەرەدان</h3>
    <form method="post">
      <div class="row">
        <label>سەرچاوە</label>
        <select name="provider_id" id="provider" required>
          {% for p in providers %}
          <option value="{{p.id}}">{{ p.name }} ({{ 'بانک' if p.kind=='bank' else 'مۆبایل' }})</option>
          {% endfor %}
        </select>
      </div>
      <div id="dyn-fields"></div>
      <div class="row">
        <label>پۆینت</label>
        <input type="number" name="points" min="{{ min_payout_points }}" required placeholder="{{ min_payout_points }}">
        <small class="muted">IQD ئەتەقریب = پۆینت × {{ money_per_point }} — فی: {{ payout_fee_points }} pts</small>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn">ناردنی داواکاری</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h3 style="margin-top:0">هەموو ڕێگاکانی پێشتر</h3>
    <table class="table">
      <thead><tr><th>سەرچاوە</th><th>وردەکاری</th><th>دۆخ</th></tr></thead>
      <tbody>
        {% for m in methods %}
          <tr>
            <td>{{ m.provider_name }} ({{ 'بانک' if m.provider_kind=='bank' else 'مۆبایل' }})</td>
            <td><code style="font-size:.9em">{{ m.account_json }}</code></td>
            <td>{{ m.status }}</td>
          </tr>
        {% else %}
          <tr><td colspan="3">هێشتا هیچ ڕێگایەکت تۆمار نەکردووە.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
async function loadFields(pid){
  const r = await fetch(`/api/payout/provider/${pid}/fields`);
  const fields = await r.json();
  const box = document.getElementById('dyn-fields');
  box.innerHTML = '';
  for (const [key, spec] of Object.entries(fields)){
    const div = document.createElement('div'); div.className='row';
    const label = spec.label || key;
    const type = spec.type || 'text';
    const required = spec.required ? 'required' : '';
    const pattern = spec.pattern ? `pattern="${spec.pattern}"` : '';
    const placeholder = spec.placeholder ? `placeholder="${spec.placeholder}"` : '';
    div.innerHTML = `<label>${label}</label>
      <input name="acc_${key}" type="${type}" ${required} ${pattern} ${placeholder} autocomplete="off">`;
    box.appendChild(div);
  }
}
const select = document.getElementById('provider');
if (select) {
  select.addEventListener('change', e=>loadFields(e.target.value));
  loadFields(select.value);
}
</script>
{% endblock %}
