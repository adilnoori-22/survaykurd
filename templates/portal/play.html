{% extends 'base.html' %}
{% block title %}{{ game.title }}{% endblock %}
{% block content %}
<div class='row'>
  <h2>{{ game.title }}</h2>
  <div class='right' style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
    <span class="pill">ژوور: <b id="room-code">{{ room }}</b></span>
    <input id="room-link-input" style="width:280px"
           value="{{ url_for('portal_game', game_id=game.id, room=room, _external=False) }}" readonly>
    <button class='btn small' type='button' onclick='copyRoomCode()'>کۆپی کۆد</button>
    <button class='btn small' type='button' onclick='copyRoomLinkInput()'>کۆپی بەستەر</button>
    <a class='btn small' href='{{ url_for("games_page") }}'>⟵ گەڕانەوە بۆ لیست</a>
    <button class='btn small' type='button' onclick='toggleFull()'>FullScreen</button>
  </div>
</div>

<div class='card' style='padding:0; overflow:hidden; margin-top:.5rem'>
  <iframe id='gameframe' src='{{ game.embed_url }}' style='width:100%; height:70vh; border:0;'></iframe>
</div>

<!-- Ad box -->
<div class='card' style="margin-top:1rem">
  <h3>ریکلام</h3>
  <div id="ad-box">
    {% if ad %}
      <a href="{{ ad.click_url }}" target="_blank" rel="noopener">
        <img src="{{ ad.image_url }}" alt="{{ ad.title or 'Ad' }}" style="max-width:100%;height:auto;border-radius:10px">
      </a>
      <div class="muted">{{ ad.title }}</div>
    {% else %}
      <div class="muted">ریکلامی چالاک نییە.</div>
    {% endif %}
  </div>
  <button class='btn small' type='button' onclick='refreshAd()'>↻ گۆڕینی ریکلام</button>
</div>

<div class='card' style="margin-top:1rem">
  <h3>Match / Stake</h3>
  <div class='row' style="gap:.5rem;flex-wrap:wrap">
    <button class='btn' type='button' onclick='createMatch({{ game.id }})'>+ دروستکردنی مچ (Stake)</button>
    <input id="match-id" placeholder="Match ID" style="width:140px">
    <button class='btn secondary' type='button'
            onclick='joinMatch(parseInt(document.getElementById("match-id").value||"0",10))'>Join</button>
    <input id="winner" placeholder="Winner username" style="width:180px">
    <button class='btn danger' type='button'
            onclick='reportWin(parseInt(document.getElementById("match-id").value||"0",10), document.getElementById("winner").value||"")'>Report Win</button>
  </div>
</div>

<div class='card' style="margin-top:1rem">
  <h3>Leaderboard ({{ room }})</h3>
  <ul id="lb-wins" style="margin:.4rem 0"></ul>
  <button class='btn small' type='button' onclick='refreshLeaderboard({{ game.id }}, "{{ room }}")'>↻ نوێکردنەوە</button>
</div>
<!-- Ad boxes -->
<div id="ad-inline" class="card" style="margin-top:1rem; display:none"></div>

<!-- Optional modal overlay -->
<div id="ad-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:1000">
  <div style="background:#fff; padding:14px; border-radius:12px; max-width:520px; width:92%">
    <div id="ad-modal-body"></div>
    <div style="text-align:right; margin-top:8px">
      <button class="btn" type="button" onclick="document.getElementById('ad-modal').style.display='none'">گەڕانەوە بۆ یاری</button>
    </div>
  </div>
</div>

<script src='/static/portal.js'></script>
<script>
  window.__ROOM__='{{ room|e }}';
  function copyRoomLinkInput(){
    const el = document.getElementById('room-link-input');
    if(!el) return;
    el.select(); el.setSelectionRange(0, 99999);
    try { document.execCommand('copy'); } catch(_) {}
    try { navigator.clipboard && navigator.clipboard.writeText(el.value); } catch(_) {}
  }
  refreshLeaderboard({{ game.id }}, '{{ room }}');
  // لە کاتی "تەواوبوونی پلە" دەتوانیت refreshAd() بانگبکەیت بۆ گۆڕینی رێکلەم
</script>
<script src="/static/portal.js"></script>
<script>window.AD_GAME_ID = {{ game.id }}; window.AD_ROOM='{{ room }}';</script>
<script src="/static/js/ads.js"></script>
<script src="/static/js/ad_hooks.js"></script>
<script>
  window.__ROOM__='{{ room|e }}';
  const GAME_ID = {{ game.id }};
// inside the embedded game
window.parent && window.parent.postMessage({type:'LEVEL_END', level: currentLevelNumber}, '*');


  async function serveAd(placement, level){
    try{
      const r = await fetch(`/api/ads/serve?game_id=${GAME_ID}&placement=${encodeURIComponent(placement)}${level!=null?`&level=${level}`:''}`);
      const j = await r.json();
      const ad = j.ok && j.ad;
      const inline = document.getElementById('ad-inline');
      if(!ad){ 
        if(inline) inline.style.display='none';
        return;
      }
      const html = `
        <a href="${ad.click_url||'#'}" target="_blank" rel="noopener">
          <img src="${ad.image_url||''}" alt="${ad.title||'Ad'}" style="max-width:100%;height:auto;border-radius:10px">
        </a>
        <div class="muted" style="margin-top:.3rem">${ad.title||''}</div>
      `;
      if(placement === 'game_start'){
        inline.innerHTML = html;
        inline.style.display='block';
      } else {
        // show modal for e.g. level_end
        const modal = document.getElementById('ad-modal');
        const body = document.getElementById('ad-modal-body');
        if(body) body.innerHTML = html;
        if(modal) modal.style.display='flex';
      }
    }catch(_){}
  }

  // 1) on load → ad at game start
  serveAd('game_start');

  // 2) listen for messages from the game to detect level start/end
  window.addEventListener('message', (ev)=>{
    try{
      const data = ev.data || {};
      if(data.type === 'LEVEL_END'){
        // optionally pass level number if game posts it
        serveAd('level_end', data.level||null);
      }
      // you can add more: LEVEL_START -> serveAd('level_start', ...)
    }catch(_){}
  });

  // Existing calls
  refreshLeaderboard(GAME_ID, '{{ room }}');
</script>

{% endblock %}
