{% extends "base.html" %}
{% block title %}بازار{% endblock %}
{% block content %}
<h2>بازار</h2>
<div class="card" style="max-width:960px">
  <div class="row"><strong>باڵانس:</strong> {{ balance }} پۆینت</div>
</div>

<div class="grid grid-3" style="margin-top:12px">
  {% for it in items %}
    {% set _is_seq = it is sequence %}
    {% set _id    = (it[0] if _is_seq else (it.id   if it.id   is defined else it['id'])) %}
    {% set _name  = (it[1] if _is_seq else (it.name if it.name is defined else it['name'])) %}
    {% set _price = (it[2] if _is_seq else (it.price_points if it.price_points is defined else it['price_points'])) %}
    {% set _stock = (it[3] if _is_seq else (it.stock if it.stock is defined else it['stock'])) %}
    {% set _meta_json = (it[4] if _is_seq else (it.meta_json if it.meta_json is defined else it.get('meta_json'))) %}
    {% set _m = (_meta_json|fromjson) if _meta_json else {} %}
    {% set _img = (_m.get('image') or _m.get('img')) %}
    <div class="card">
      <h3 style="margin-top:0">{{ _name }}</h3>

      {% if _img %}
      <div class="row">
        <a href="{{ _img }}" target="_blank" rel="noopener">
          <img src="{{ _img }}" style="max-width:100%;border-radius:12px;margin:.4rem 0">
        </a>
      </div>
      {% endif %}

      {% set _desc = _m.get('short_desc') or _m.get('desc') %}
      {% if _desc %}<p class="muted" style="margin:.25rem 0">{{ _desc }}</p>{% endif %}

      <div class="row">جۆر: {{ _m.get('type') or '—' }}</div>
      <div class="row">دۆخ: {{ _m.get('status') or '—' }}</div>
      <div class="row">مۆدێل: {{ _m.get('model') or '—' }}</div>

      <div class="row">نرخ: {{ _price }} پۆینت</div>
      <div class="row">کۆی بەردەست: {{ _stock }}</div>
      <form method="post" style="margin-top:.5rem">
        <input type="hidden" name="item_id" value="{{ _id }}">
        <div class="row">
          <label>دانە</label>
          <input type="number" name="qty" value="1" min="1" max="{{ _stock }}">
        </div>
        <button class="btn btn-primary" type="submit">کڕین</button>
      </form>
    </div>
  {% endfor %}
</div>
{% endblock %}
